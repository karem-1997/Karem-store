<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAREM STORE | PRO SYSTEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --main: #ff0000; --bg: #000; --card: #111; --green: #2ecc71; --gray: #222; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; }
        body { background: var(--bg); color: #fff; margin: 0; padding-bottom: 70px; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { background: #000; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gray); position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: 900; font-size: 1.4rem; color: var(--main); }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--main); object-fit: cover; }

        /* Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
        .slider { width: 95%; height: 160px; margin: 10px auto; border-radius: 15px; overflow: hidden; position: relative; }
        .slides { display: flex; transition: 0.5s; height: 100%; }
        .slides img { min-width: 100%; object-fit: cover; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ */
        .agent-card { background: var(--card); margin: 15px; padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--gray); }
        .agent-info h3 { margin: 0; font-size: 1rem; }
        .agent-info p { margin: 5px 0 0; color: var(--green); font-weight: bold; }

        /* Ø§Ù„Ù…ØªØ¬Ø± */
        .section-title { padding: 10px 20px; color: var(--main); font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 15px; }
        .product { background: var(--card); border-radius: 12px; padding: 10px; text-align: center; border: 1px solid var(--gray); }
        .product img { width: 100%; aspect-ratio: 1/1; border-radius: 8px; object-fit: cover; }
        .product h4 { font-size: 0.7rem; margin: 8px 0; height: 30px; overflow: hidden; }
        .product b { color: var(--green); font-size: 0.8rem; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .admin-zone { background: #0a0000; border: 1px solid var(--main); margin: 15px; padding: 15px; border-radius: 15px; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 10px; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-main { background: var(--main); color: #fff; }
        .btn-green { background: var(--green); color: #000; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #111; width: 100%; max-width: 400px; padding: 20px; border-radius: 20px; border: 1px solid #333; }

        .hidden { display: none !important; }
        .side-menu { position: fixed; top: 0; right: -100%; width: 80%; height: 100%; background: #000; z-index: 4000; transition: 0.3s; padding: 20px; border-left: 1px solid var(--gray); }
        .side-menu.active { right: 0; }
    </style>
</head>
<body>

<header>
    <div class="logo">KAREM STORE</div>
    <div id="userHeader" class="hidden" onclick="toggleMenu()">
        <img id="myAvatarHead" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="user-avatar">
    </div>
    <i class="fa-solid fa-bars-staggered" style="font-size: 1.5rem;" onclick="toggleMenu()"></i>
</header>

<div class="slider">
    <div class="slides" id="sliderContainer">
        </div>
</div>

<div id="agentProfile" class="hidden">
    <div class="agent-card">
        <div style="position: relative;">
            <img id="myAvatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
            <label for="imgInput" style="position: absolute; bottom: 0; right: 0; background: var(--main); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer;"><i class="fa-solid fa-camera"></i></label>
            <input type="file" id="imgInput" class="hidden" accept="image/*" onchange="updateMyPhoto()">
        </div>
        <div class="agent-info">
            <h3 id="myName">--</h3>
            <p>Ø±ØµÙŠØ¯Ùƒ: <span id="myBalance">0</span> Ø¬</p>
            <small id="myID" style="color:#888"></small>
        </div>
    </div>
</div>

<div id="adminArea" class="hidden">
    <div class="admin-zone">
        <h3 style="margin:0 0 10px; color:var(--main)">ğŸ› ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ÙƒØ±ÙŠÙ…</h3>
        <button class="btn btn-main" onclick="showTab('addP')">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
        <button class="btn btn-main" onclick="showTab('manageB')">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø±</button>
        <button class="btn btn-main" onclick="showTab('chargeA')">Ø´Ø­Ù† ÙˆÙƒÙ„Ø§Ø¡</button>
        
        <div id="addP" class="admin-tab hidden">
            <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="pPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©">
            <input type="file" id="pFile" accept="image/*">
            <button class="btn btn-green" onclick="uploadProduct()">Ø±ÙØ¹ Ù„Ù„Ù…ØªØ¬Ø±</button>
        </div>
        <div id="manageB" class="admin-tab hidden">
            <input type="file" id="bFile" accept="image/*">
            <button class="btn btn-green" onclick="uploadBanner()">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø± Ù…ØªØ­Ø±Ùƒ</button>
        </div>
        <div id="chargeA" class="admin-tab hidden">
            <input type="number" id="searchID" placeholder="ID Ø§Ù„ÙˆÙƒÙŠÙ„">
            <button class="btn btn-main" onclick="searchAgent()">Ø¨Ø­Ø«</button>
            <div id="searchRes" class="hidden">
                <p id="resName"></p>
                <input type="number" id="chargeAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <button class="btn btn-green" onclick="confirmCharge()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†</button>
            </div>
        </div>
    </div>
</div>

<div id="storeView">
    <div class="section-title">ğŸ“¦ ÙƒØ§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    <div class="grid" id="mainGrid"></div>
</div>

<div id="buyModal" class="modal">
    <div class="modal-content">
        <h3 id="btitle"></h3>
        <p>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©: <span id="bprice"></span> Ø¬</p>
        <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
        <input type="number" id="bqty" value="1" min="1" oninput="recalc()">
        <h2 style="color:var(--green)">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="btotal">0</span> Ø¬</h2>
        <div id="buyBtnContainer"></div>
        <button class="btn" onclick="closeModal('buyModal')" style="background:#222; color:#fff; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div class="side-menu" id="sideMenu">
    <div id="guestSide">
        <button class="btn btn-main" onclick="openAuth()">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
    </div>
    <div id="userSide" class="hidden">
        <button class="btn btn-green" onclick="alert('ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ø´Ø­Ù†')">Ø·Ù„Ø¨ Ø´Ø­Ù† Ø±ØµÙŠØ¯</button>
        <button class="btn" style="background:#333; color:#fff; margin-top:50px;" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<div id="authModal" class="modal">
    <div class="modal-content">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <input type="text" id="regName" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù„Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯)">
        <input type="email" id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="regPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-main" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" onclick="closeModal('authModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAalmOWMUhvCi_PuFSUbXRpbe1hmGyer7s",
        authDomain: "karem-store.firebaseapp.com",
        databaseURL: "https://karem-store-default-rtdb.firebaseio.com",
        projectId: "karem-store",
        storageBucket: "karem-store.firebasestorage.app",
        messagingSenderId: "898294902448",
        appId: "1:898294902448:web:23cbee5afd72adcb67d575",
        measurementId: "G-V56WJVTN4J"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = null;
    let selItem = null;
    let targetEmail = '';

    function toggleMenu() { document.getElementById('sideMenu').classList.toggle('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openAuth() { document.getElementById('authModal').classList.add('active'); toggleMenu(); }
    function showTab(id) { document.querySelectorAll('.admin-tab').forEach(t=>t.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }

    // Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„
    function handleAuth() {
        const email = document.getElementById('regEmail').value.replace(/\./g, '_').toLowerCase();
        const pass = document.getElementById('regPass').value;
        const name = document.getElementById('regName').value;

        if(email === 'admin@karem_com' && pass === '123456') {
            login({ name: 'ÙƒØ±ÙŠÙ… (Ø§Ù„Ù…Ø¯ÙŠØ±)', email, uid: 1001, role: 'admin', balance: 0, photo: '' });
            return;
        }

        db.ref('users/' + email).once('value', snap => {
            if(snap.exists()) {
                if(snap.val().pass === pass) login(snap.val());
                else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯");
            } else {
                db.ref('lastID').transaction(c => {
                    const next = (c || 1000) + 1;
                    const u = { name, email, pass, balance:0, uid:next, role:'user', photo:'' };
                    db.ref('users/'+email).set(u);
                    db.ref('idMap/'+next).set(email);
                    login(u); return next;
                });
            }
        });
    }

    function login(d) {
        user = d;
        closeModal('authModal');
        document.getElementById('userHeader').classList.remove('hidden');
        document.getElementById('agentProfile').classList.remove('hidden');
        document.getElementById('guestSide').classList.add('hidden');
        document.getElementById('userSide').classList.remove('hidden');
        document.getElementById('myName').innerText = d.name;
        document.getElementById('myID').innerText = "ÙƒÙˆØ¯ Ø§Ù„ÙˆÙƒÙŠÙ„: " + d.uid;
        if(d.photo) { document.getElementById('myAvatar').src = d.photo; document.getElementById('myAvatarHead').src = d.photo; }
        
        db.ref('users/'+d.email+'/balance').on('value', s => {
            user.balance = s.val() || 0;
            document.getElementById('myBalance').innerText = user.balance;
        });
        
        if(d.role === 'admin') document.getElementById('adminArea').classList.remove('hidden');
        renderStore();
    }

    // ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„ÙˆÙƒÙŠÙ„
    function updateMyPhoto() {
        const file = document.getElementById('imgInput').files[0];
        const r = new FileReader();
        r.onload = e => {
            db.ref('users/'+user.email).update({ photo: e.target.result });
            document.getElementById('myAvatar').src = e.target.result;
            document.getElementById('myAvatarHead').src = e.target.result;
        };
        r.readAsDataURL(file);
    }

    // Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø´Ø±Ø§Ø¡
    function renderStore() {
        db.ref('products').on('value', snap => {
            const grid = document.getElementById('mainGrid'); grid.innerHTML = "";
            snap.forEach(s => {
                const p = s.val();
                const div = document.createElement('div');
                div.className = 'product';
                div.innerHTML = `<img src="${p.img}"><h4>${p.n}</h4><b>${p.p} Ø¬</b>`;
                div.onclick = () => openBuy(p);
                grid.appendChild(div);
            });
        });
    }

    function openBuy(p) {
        if(!user) return openAuth();
        selItem = p;
        document.getElementById('buyModal').classList.add('active');
        document.getElementById('btitle').innerText = p.n;
        document.getElementById('bprice').innerText = p.p;
        document.getElementById('bqty').value = 1;
        recalc();
    }

    function recalc() {
        const q = document.getElementById('bqty').value;
        const total = q * selItem.p;
        document.getElementById('btotal').innerText = total;
        const btnBox = document.getElementById('buyBtnContainer');
        if(user.balance >= total) {
            btnBox.innerHTML = `<button class="btn btn-green" onclick="confirmBuy(${total}, ${q})">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ âœ…</button>`;
        } else {
            btnBox.innerHTML = `<button class="btn btn-main" onclick="alert('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ')">Ø§Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø´Ø±Ø§Ø¡ âš ï¸</button>`;
        }
    }

    function confirmBuy(total, q) {
        if(confirm('Ø³ÙŠØªÙ… Ø®ØµÙ… ' + total + ' Ø¬ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ')) {
            db.ref('users/'+user.email).update({ balance: user.balance - total });
            db.ref('orders').push({ user: user.name, id: user.uid, product: selItem.n, qty: q, total: total });
            alert("ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
            closeModal('buyModal');
        }
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¯ÙŠØ±
    function uploadProduct() {
        const n = document.getElementById('pName').value;
        const p = document.getElementById('pPrice').value;
        const f = document.getElementById('pFile').files[0];
        const r = new FileReader();
        r.onload = e => db.ref('products').push({ n, p: Number(p), img: e.target.result });
        r.readAsDataURL(f); alert("ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }

    function uploadBanner() {
        const f = document.getElementById('bFile').files[0];
        const r = new FileReader();
        r.onload = e => db.ref('banners').push(e.target.result);
        r.readAsDataURL(f); alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø±");
    }

    function searchAgent() {
        const id = document.getElementById('searchID').value;
        db.ref('idMap/'+id).once('value', snap => {
            if(!snap.exists()) return alert("ID Ø®Ø·Ø£");
            targetEmail = snap.val();
            db.ref('users/'+targetEmail).once('value', s => {
                document.getElementById('searchRes').classList.remove('hidden');
                document.getElementById('resName').innerText = "Ø§Ù„ÙˆÙƒÙŠÙ„: " + s.val().name + " (" + s.val().balance + " Ø¬)";
            });
        });
    }

    function confirmCharge() {
        const a = Number(document.getElementById('chargeAmt').value);
        db.ref('users/'+targetEmail).once('value', s => {
            db.ref('users/'+targetEmail).update({ balance: (s.val().balance||0) + a });
            alert("ØªÙ… Ø§Ù„Ø´Ø­Ù†");
        });
    }

    // Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ†)
    db.ref('banners').on('value', snap => {
        const cont = document.getElementById('sliderContainer'); cont.innerHTML = "";
        snap.forEach(s => cont.innerHTML += `<img src="${s.val()}">`);
    });
    let sIdx = 0;
    setInterval(() => {
        const cont = document.getElementById('sliderContainer');
        if(cont.children.length > 1) {
            sIdx++; if(sIdx >= cont.children.length) sIdx = 0;
            cont.style.transform = `translateX(${sIdx * 100}%)`;
        }
    }, 2000);

    renderStore();
</script>
</body>
</html>
