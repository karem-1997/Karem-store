<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAREM STORE | Ø§Ù„Ø´Ø§Ù…Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --main: #ff0000; --bg: #000; --card: #0f0f0f; --green: #00ff00; --gray: #1e1e1e; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: #fff; margin: 0; padding-bottom: 80px; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { background: #000; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--main); position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: 900; font-size: 1.5rem; color: var(--main); text-shadow: 0 0 10px var(--main); }

        /* ÙƒØ§Ø±Øª Ø§Ù„ÙˆÙƒÙŠÙ„ */
        .u-card { background: var(--card); margin: 15px; padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--gray); border-right: 5px solid var(--main); }
        .u-card img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--main); object-fit: cover; }
        .u-info h3 { margin: 0; font-size: 1rem; }
        .u-info p { margin: 5px 0 0; color: var(--green); font-weight: bold; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø´Ø¨ÙƒØ© */
        .grid-cats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .cat-box { background: var(--card); border-radius: 15px; padding: 20px; text-align: center; border: 1px solid var(--gray); cursor: pointer; }
        .cat-box:hover { border-color: var(--main); background: #1a0000; }
        .cat-box i { font-size: 2.5rem; color: var(--main); margin-bottom: 10px; }

        /* Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .grid-prods { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .prod-box { background: var(--card); border-radius: 12px; padding: 8px; text-align: center; border: 1px solid var(--gray); }
        .prod-box img { width: 100%; aspect-ratio: 1/1; border-radius: 10px; object-fit: cover; }
        .prod-box h4 { font-size: 0.8rem; margin: 8px 0; height: 35px; overflow: hidden; }
        .prod-box b { color: var(--green); display: block; margin-bottom: 5px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .adm-panel { background: #050505; border: 2px solid var(--main); margin: 15px; padding: 15px; border-radius: 20px; }
        .tabs { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 15px; }
        .tab-btn { background: var(--gray); color: #fff; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { background: var(--main); font-weight: bold; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 10px; }
        .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--main); color: #fff; }
        .btn-green { background: var(--green); color: #000; }
        .btn-del { background: #ff3333; color: #fff; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #0a0a0a; width: 100%; max-width: 400px; padding: 25px; border-radius: 25px; border: 1px solid #333; position: relative; }

        .user-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #111; margin-bottom: 8px; border-radius: 10px; border-right: 3px solid var(--main); }

        .hidden { display: none !important; }
        #backBtn { background: var(--gray); color: #fff; padding: 8px 15px; border-radius: 10px; margin: 10px 15px; display: inline-block; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="logo">KAREM STORE</div>
    <div id="uHeader" class="hidden"><img id="hImg" src="" style="width:35px; height:35px; border-radius:50%; border:1px solid var(--main)"></div>
    <i class="fa-solid fa-lock" id="lockIcon" onclick="openAuth()"></i>
</header>

<div id="uArea" class="hidden">
    <div class="u-card">
        <img id="uImg" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
        <div class="u-info">
            <h3 id="un">--</h3>
            <p>Ø±ØµÙŠØ¯Ùƒ: <span id="ub">0</span> Ø¬</p>
            <small id="ui"></small>
        </div>
    </div>
</div>

<div id="admArea" class="hidden">
    <div class="adm-panel">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('t1', this)">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
            <button class="tab-btn" onclick="showTab('t2', this)">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
            <button class="tab-btn" onclick="showTab('t3', this)">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
            <button class="tab-btn" onclick="showTab('t4', this)">Ø´Ø­Ù†</button>
        </div>

        <div id="t1" class="t-content">
            <input type="text" id="cn" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…">
            <input type="text" id="ci" placeholder="Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ù…Ø«Ù„ fa-gamepad)">
            <button class="btn btn-main" onclick="addCat()">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div id="t2" class="t-content hidden">
            <select id="cpList"></select>
            <input type="text" id="pn" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="pp" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ§Ø­Ø¯">
            <input type="file" id="pf" accept="image/*">
            <button class="btn btn-main" onclick="addProd()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        </div>

        <div id="t3" class="t-content hidden">
            <div style="background:#111; padding:10px; border-radius:10px; margin-bottom:15px;">
                <h4 style="margin:0 0 10px;">ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ù…Ù†</h4>
                <input type="text" id="an" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <input type="email" id="ae" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
                <input type="password" id="ap" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯">
                <button class="btn btn-green" onclick="createAdmin()">Ø­ÙØ¸ ÙƒØ£Ø¯Ù…Ù†</button>
            </div>
            <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† (Ø­Ø°Ù):</h4>
            <div id="usersBox" style="max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div id="t4" class="t-content hidden">
            <input type="number" id="sid" placeholder="ID Ø§Ù„ÙˆÙƒÙŠÙ„">
            <button class="btn btn-green" onclick="findU()">Ø¨Ø­Ø«</button>
            <div id="rBox" class="hidden">
                <p id="rt"></p>
                <input type="number" id="ra" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <button class="btn btn-green" onclick="doCharge()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†</button>
            </div>
        </div>
    </div>
</div>

<div id="catsView"><div class="grid-cats" id="catsBox"></div></div>
<div id="prodsView" class="hidden">
    <div id="backBtn" onclick="goBack()"><i class="fa-solid fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</div>
    <h3 id="ct" style="padding:0 20px; color:var(--main)"></h3>
    <div class="grid-prods" id="prodsBox"></div>
</div>

<div id="buyModal" class="modal">
    <div class="modal-content">
        <h3 id="mt"></h3>
        <p>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©: <b id="mp"></b> Ø¬</p>
        <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</label>
        <input type="number" id="mq" value="1" min="1" oninput="calc()">
        <h2 style="color:var(--green)">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="mtot">0</span> Ø¬</h2>
        <div id="mAct"></div>
        <button class="btn" onclick="closeM('buyModal')" style="margin-top:10px; background:#222; color:#fff;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div id="authModal" class="modal">
    <div class="modal-content">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†ØµØ©</h3>
        <input type="text" id="rn" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù„Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯)">
        <input type="email" id="re" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
        <input type="password" id="rp" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯">
        <button class="btn btn-main" onclick="auth()">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAalmOWMUhvCi_PuFSUbXRpbe1hmGyer7s",
        authDomain: "karem-store.firebaseapp.com",
        databaseURL: "https://karem-store-default-rtdb.firebaseio.com",
        projectId: "karem-store",
        storageBucket: "karem-store.firebasestorage.app",
        messagingSenderId: "898294902448",
        appId: "1:898294902448:web:23cbee5afd72adcb67d575"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = null; let selP = null; let tMail = '';

    function closeM(id) { document.getElementById(id).classList.remove('active'); }
    function openAuth() { document.getElementById('authModal').classList.add('active'); }
    function showTab(id, btn) {
        document.querySelectorAll('.t-content').forEach(c=>c.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        btn.classList.add('active');
    }
    function goBack() { document.getElementById('catsView').classList.remove('hidden'); document.getElementById('prodsView').classList.add('hidden'); }

    // --- Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ---
    function auth() {
        const e = document.getElementById('re').value.replace(/\./g, '_').toLowerCase();
        const p = document.getElementById('rp').value;
        const n = document.getElementById('rn').value;

        if(e === 'admin@karem_com' && p === '123456') {
            login({ name: 'ÙƒØ±ÙŠÙ… (Ø§Ù„Ù…Ø¯ÙŠØ±)', email: e, uid: '1001', role: 'admin', balance: 99999 }); return;
        }

        db.ref('users/'+e).once('value', s => {
            if(s.exists()) {
                if(s.val().pass === p) login(s.val());
                else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯");
            } else {
                db.ref('lastID').transaction(c => {
                    const id = (c || 1000) + 1;
                    const u = { name: n, email: e, pass: p, balance: 0, uid: id, role: 'user' };
                    db.ref('users/'+e).set(u);
                    db.ref('idMap/'+id).set(e);
                    login(u); return id;
                });
            }
        });
    }

    function login(d) {
        user = d; closeM('authModal');
        document.getElementById('uHeader').classList.remove('hidden');
        document.getElementById('uArea').classList.remove('hidden');
        document.getElementById('un').innerText = d.name;
        document.getElementById('ui').innerText = "ID: " + d.uid;
        document.getElementById('lockIcon').className = "fa-solid fa-right-from-bracket";
        document.getElementById('lockIcon').onclick = () => location.reload();
        
        db.ref('users/'+d.email+'/balance').on('value', s => {
            user.balance = s.val() || 0;
            document.getElementById('ub').innerText = user.balance;
        });

        if(d.role === 'admin') {
            document.getElementById('admArea').classList.remove('hidden');
            loadAllUsers();
        }
        loadCats();
    }

    function createAdmin() {
        const e = document.getElementById('ae').value.replace(/\./g, '_').toLowerCase();
        const p = document.getElementById('ap').value;
        const n = document.getElementById('an').value;
        db.ref('users/'+e).set({ name: n, email: e, pass: p, balance: 0, role: 'admin', uid: 'ADM' });
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø¯Ù…Ù†");
    }

    function loadAllUsers() {
        db.ref('users').on('value', s => {
            const box = document.getElementById('usersBox'); box.innerHTML = "";
            s.forEach(u => {
                const ud = u.val();
                box.innerHTML += `<div class="user-list-item">
                    <span>${ud.name} (${ud.role})</span>
                    <button class="btn-del" onclick="delUser('${ud.email}')">Ø­Ø°Ù</button>
                </div>`;
            });
        });
    }
    function delUser(em) { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ")) db.ref('users/'+em).remove(); }

    // --- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
    function addCat() {
        const n = document.getElementById('cn').value;
        const i = document.getElementById('ci').value || 'fa-box';
        db.ref('categories').push({ name: n, icon: i });
        alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…");
    }

    function loadCats() {
        db.ref('categories').on('value', s => {
            const box = document.getElementById('catsBox'); box.innerHTML = "";
            const list = document.getElementById('cpList'); list.innerHTML = "";
            s.forEach(c => {
                const cd = c.val();
                box.innerHTML += `<div class="cat-box" onclick="openCat('${c.key}', '${cd.name}')">
                    <i class="fa-solid ${cd.icon}"></i><h3>${cd.name}</h3>
                </div>`;
                list.innerHTML += `<option value="${c.key}">${cd.name}</option>`;
            });
        });
    }

    function addProd() {
        const c = document.getElementById('cpList').value;
        const n = document.getElementById('pn').value;
        const p = document.getElementById('pp').value;
        const f = document.getElementById('pf').files[0];
        const r = new FileReader();
        r.onload = e => db.ref('products/'+c).push({ n, p: Number(p), img: e.target.result });
        r.readAsDataURL(f); alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!");
    }

    function openCat(id, name) {
        document.getElementById('catsView').classList.add('hidden');
        document.getElementById('prodsView').classList.remove('hidden');
        document.getElementById('ct').innerText = name;
        db.ref('products/'+id).on('value', s => {
            const box = document.getElementById('prodsBox'); box.innerHTML = "";
            s.forEach(p => {
                const pd = p.val();
                box.innerHTML += `<div class="prod-box" onclick='openBuy(${JSON.stringify(pd)})'>
                    <img src="${pd.img}"><h4>${pd.n}</h4><b>${pd.p} Ø¬</b>
                </div>`;
            });
        });
    }

    function openBuy(p) {
        if(!user) return openAuth();
        selP = p; document.getElementById('buyModal').classList.add('active');
        document.getElementById('mt').innerText = p.n;
        document.getElementById('mp').innerText = p.p;
        document.getElementById('mq').value = 1; calc();
    }

    function calc() {
        const q = document.getElementById('mq').value;
        const tot = q * selP.p;
        document.getElementById('mtot').innerText = tot;
        const btn = document.getElementById('mAct');
        if(user.balance >= tot) btn.innerHTML = `<button class="btn btn-green" onclick="doBuy(${tot}, ${q})">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù† âœ…</button>`;
        else btn.innerHTML = `<button class="btn" style="background:#444" disabled>Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ù„Ø´Ø±Ø§Ø¡ âš ï¸</button>`;
    }

    function doBuy(t, q) {
        db.ref('users/'+user.email).update({ balance: user.balance - t });
        db.ref('orders').push({ user: user.name, id: user.uid, product: selP.n, qty: q, total: t });
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ!"); closeM('buyModal');
    }

    // --- Ø§Ù„Ø´Ø­Ù† ---
    function findU() {
        const id = document.getElementById('sid').value;
        db.ref('idMap/'+id).once('value', s => {
            if(!s.exists()) return alert("ID ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            tMail = s.val();
            db.ref('users/'+tMail).once('value', u => {
                document.getElementById('rBox').classList.remove('hidden');
                document.getElementById('rt').innerText = "Ø§Ù„ÙˆÙƒÙŠÙ„: " + u.val().name;
            });
        });
    }
    function doCharge() {
        const a = Number(document.getElementById('ra').value);
        db.ref('users/'+tMail).once('value', s => {
            db.ref('users/'+tMail).update({ balance: (s.val().balance||0)+a });
            alert("ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­!");
        });
    }

    loadCats();
</script>
</body>
</html>
