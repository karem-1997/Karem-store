<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELMY CARD | PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --main: #8a2be2; --bg: #000; --card: #0a0a0a; --green: #00ff00; --red: #ff3333; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: #fff; margin: 0; overflow-x: hidden; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #000; border-bottom: 1px solid #222; position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .balance-tag { background: rgba(138, 43, 226, 0.2); padding: 5px 12px; border-radius: 20px; color: var(--main); font-weight: bold; border: 1px solid var(--main); }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø©) */
        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; padding: 20px; animation: slideIn 0.3s; }
        .full-modal.active { display: flex; }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .buy-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .buy-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .input-group { background: #111; padding: 15px; border-radius: 25px; text-align: center; border: 1px solid #222; }
        .input-group label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 5px; }
        .input-group input { background: transparent; border: none; color: #fff; text-align: center; width: 100%; font-size: 1.2rem; outline: none; }
        
        .id-input { background: #111; padding: 20px; border-radius: 30px; margin-bottom: 30px; border: 1px solid #222; }
        .id-input input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-size: 1.5rem; outline: none; }

        .buy-footer { display: flex; gap: 15px; }
        .btn-buy { flex: 2; background: linear-gradient(45deg, #4b0082, #8a2be2); padding: 18px; border-radius: 30px; border: none; color: #fff; font-weight: bold; font-size: 1.1rem; }
        .btn-cancel { flex: 1; background: transparent; border: 1px solid var(--red); color: var(--red); padding: 18px; border-radius: 30px; font-weight: bold; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .card { background: var(--card); border-radius: 15px; padding: 15px; text-align: center; border: 1px solid #1a1a1a; cursor: pointer; }
        .card img { width: 100%; border-radius: 10px; margin-bottom: 10px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .admin-section { background: #050505; border: 1px solid var(--main); margin: 15px; padding: 15px; border-radius: 20px; }
        .order-card { background: #111; padding: 15px; border-radius: 15px; margin-bottom: 10px; border-right: 4px solid var(--main); }

        .hidden { display: none !important; }
        .notice { background: rgba(255, 51, 51, 0.1); border: 1px solid #331111; padding: 15px; border-radius: 15px; font-size: 0.85rem; line-height: 1.6; margin-top: 20px; color: #ccc; }
    </style>
</head>
<body>

<header>
    <div class="logo">ğŸ‘¤ <span id="userNameDisplay">Helmy</span></div>
    <div class="balance-tag" id="userBalanceDisplay">0 Ø¬</div>
</header>

<div id="adminPanel" class="hidden">
    <div class="admin-section">
        <h3 style="color:var(--main)">ğŸ”” Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
        <div id="orderContainer">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>
        <hr style="border:0.5px solid #222; margin:20px 0;">
        <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
        <input type="text" id="newPName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input type="number" id="newPPrice" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø©)">
        <input type="number" id="newPCoins" placeholder="ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙˆÙŠÙ†Ø² Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©">
        <input type="file" id="newPImg">
        <button class="btn-buy" style="width:100%" onclick="addNewProduct()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</button>
    </div>
</div>

<div id="mainStore">
    <div class="grid" id="productGrid"></div>
</div>

<div id="buyModal" class="full-modal">
    <div class="buy-header">
        <span class="balance-tag" id="modalPriceTag">0 Ø¬</span>
        <span style="font-weight: bold;"><i class="fa-solid fa-heart"></i> <span id="modalProdName">karak chat</span></span>
    </div>

    <div class="buy-inputs">
        <div class="input-group">
            <label>Ø§Ù„Ø¹Ø¯Ø¯</label>
            <input type="number" id="inputQty" value="1" oninput="calculateTotal()">
        </div>
        <div class="input-group">
            <label>Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ</label>
            <div style="font-size:1.2rem; font-weight:bold;"><span id="totalDisplay">0</span> Ø¬</div>
        </div>
    </div>

    <div class="id-input">
        <input type="text" id="gameID" placeholder="id">
    </div>

    <div class="buy-footer">
        <button class="btn-buy" onclick="confirmOrder()">Ø´Ø±Ø§Ø¡</button>
        <button class="btn-cancel" onclick="closeBuyModal()">Ø§Ù„ØºØ§Ø¡</button>
    </div>

    <div class="notice">
        Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ÙŠØ¯ÙˆÙŠ ÙŠØ£Ø®Ø° Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª<br>
        ğŸš¨ <b>ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ø§Ø§Ø§Ø§Ù… Ø¬Ø¯Ù‹Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</b> ğŸš¨<br>
        Ù†ÙˆØ¯ Ø¥Ø¹Ù„Ø§Ù…ÙƒÙ… Ø£Ù† Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø±Ø³Ù…ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø²Ø¨ÙˆÙ† Ù‡Ùˆ: 1 Ø¯ÙˆÙ„Ø§Ø± = 50,000 Ø£Ùˆ 55,000. Ø£ÙŠ Ø´Ø®Øµ ÙŠØ®Ø§Ù„Ù Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø³ÙŠØ¹Ø±Ø¶ Ø­Ø³Ø§Ø¨Ù‡ Ù„Ù„Ø­Ø¸Ø± Ø§Ù„Ø¯Ø§Ø¦Ù….
    </div>
</div>

<div id="authModal" class="full-modal" style="display: flex; justify-content: center; align-items: center;">
    <div style="width: 100%; max-width: 400px; text-align: center;">
        <h2 style="color:var(--main)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="width:100%; padding:15px; border-radius:15px; background:#111; border:1px solid #222; color:#fff; margin-bottom:10px;">
        <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:100%; padding:15px; border-radius:15px; background:#111; border:1px solid #222; color:#fff; margin-bottom:20px;">
        <button class="btn-buy" style="width:100%" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAalmOWMUhvCi_PuFSUbXRpbe1hmGyer7s",
        authDomain: "karem-store.firebaseapp.com",
        databaseURL: "https://karem-store-default-rtdb.firebaseio.com",
        projectId: "karem-store",
        storageBucket: "karem-store.firebasestorage.app",
        messagingSenderId: "898294902448",
        appId: "1:898294902448:web:23cbee5afd72adcb67d575"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let selectedProd = null;

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    function handleAuth() {
        const e = document.getElementById('email').value.replace(/\./g, '_').toLowerCase();
        const p = document.getElementById('pass').value;

        if(e === 'admin@karem_com' && p === '123456') {
            setupUser({ name: 'Ø§Ù„Ù…Ø¯ÙŠØ±', email: e, role: 'admin', balance: 999999, uid: 'ADMIN' });
        } else {
            db.ref('users/'+e).once('value', s => {
                if(s.exists() && s.val().pass === p) {
                    setupUser(s.val());
                } else if (!s.exists()) {
                    // ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø¢Ù„ÙŠØ§Ù‹ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
                    const newUser = { name: 'ÙˆÙƒÙŠÙ„ Ø¬Ø¯ÙŠØ¯', email: e, pass: p, role: 'user', balance: 0, uid: Math.floor(Math.random()*9000)+1000 };
                    db.ref('users/'+e).set(newUser);
                    setupUser(newUser);
                } else { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
            });
        }
    }

    function setupUser(data) {
        currentUser = data;
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('userNameDisplay').innerText = data.name;
        document.getElementById('userBalanceDisplay').innerText = data.balance + " Ø¬";
        
        if(data.role === 'admin') {
            document.getElementById('adminPanel').classList.remove('hidden');
            listenToOrders();
        }
        loadProducts();
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
    function addNewProduct() {
        const n = document.getElementById('newPName').value;
        const p = Number(document.getElementById('newPPrice').value);
        const c = Number(document.getElementById('newPCoins').value);
        const f = document.getElementById('newPImg').files[0];
        const r = new FileReader();
        r.onload = (e) => {
            db.ref('products').push({ name: n, price: p, coins: c, img: e.target.result });
            alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
        };
        r.readAsDataURL(f);
    }

    function loadProducts() {
        db.ref('products').on('value', s => {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = "";
            s.forEach(p => {
                const pd = p.val();
                grid.innerHTML += `
                    <div class="card" onclick='openBuyModal(${JSON.stringify(pd)})'>
                        <img src="${pd.img}">
                        <b>${pd.name}</b>
                        <div style="color:var(--main); margin-top:5px;">${pd.price} Ø¬</div>
                    </div>`;
            });
        });
    }

    // --- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø©) ---
    function openBuyModal(prod) {
        selectedProd = prod;
        document.getElementById('buyModal').classList.add('active');
        document.getElementById('modalProdName').innerText = prod.name;
        document.getElementById('modalPriceTag').innerText = prod.price + " Ø¬";
        document.getElementById('inputQty').value = prod.coins;
        calculateTotal();
    }

    function calculateTotal() {
        const qty = Number(document.getElementById('inputQty').value);
        // Ø§Ù„Ø³Ø¹Ø± = (Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© / ÙƒÙ…ÙŠØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©) * Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©
        const total = (qty / selectedProd.coins) * selectedProd.price;
        document.getElementById('totalDisplay').innerText = total.toFixed(2);
    }

    function closeBuyModal() { document.getElementById('buyModal').classList.remove('active'); }

    function confirmOrder() {
        const id = document.getElementById('gameID').value;
        const total = Number(document.getElementById('totalDisplay').innerText);
        const qty = document.getElementById('inputQty').value;

        if(!id) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù€ ID");
        if(currentUser.balance < total) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ");

        // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø¤Ù‚ØªØ§Ù‹
        db.ref('users/'+currentUser.email).update({ balance: (currentUser.balance - total).toFixed(2) });

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        db.ref('orders').push({
            uName: currentUser.name,
            uMail: currentUser.email,
            prod: selectedProd.name,
            qty: qty,
            total: total,
            gameID: id,
            status: 'pending',
            time: new Date().toLocaleString()
        });

        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ±");
        closeBuyModal();
    }

    // --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: Ù‚Ø¨ÙˆÙ„/Ø±ÙØ¶ ---
    function listenToOrders() {
        db.ref('orders').on('value', s => {
            const container = document.getElementById('orderContainer');
            container.innerHTML = "";
            s.forEach(o => {
                const d = o.val();
                if(d.status === 'pending') {
                    container.innerHTML += `
                        <div class="order-card">
                            <div style="font-weight:bold; color:var(--main)">${d.prod} (${d.qty})</div>
                            <div>Ø§Ù„ÙˆÙƒÙŠÙ„: ${d.uName}</div>
                            <div style="color:var(--green)">ID Ø§Ù„Ù„Ø¹Ø¨Ø©: ${d.gameID}</div>
                            <div style="font-size:0.8rem; color:#888">${d.time}</div>
                            <div style="margin-top:10px; display:flex; gap:10px;">
                                <button class="btn-buy" style="padding:10px; font-size:0.8rem;" onclick="updateOrder('${o.key}', 'approved')">Ù…ÙˆØ§ÙÙ‚Ø© âœ…</button>
                                <button class="btn-cancel" style="padding:10px; font-size:0.8rem;" onclick="rejectOrder('${o.key}', '${d.uMail}', ${d.total})">Ø±ÙØ¶ âŒ</button>
                            </div>
                        </div>`;
                }
            });
        });
    }

    function updateOrder(key, status) {
        db.ref('orders/'+key).update({ status: status });
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨");
    }

    function rejectOrder(key, uMail, refundAmount) {
        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø§Ù„ Ù„Ù„ÙˆÙƒÙŠÙ„
        db.ref('users/'+uMail).once('value', s => {
            const currentBal = Number(s.val().balance);
            db.ref('users/'+uMail).update({ balance: (currentBal + refundAmount).toFixed(2) });
            db.ref('orders/'+key).update({ status: 'rejected' });
            alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±ØµÙŠØ¯");
        });
    }
</script>
</body>
</html>
