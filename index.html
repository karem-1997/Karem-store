<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELMY CARD | THE MASTER SYSTEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --main: #8a2be2; --bg: #000; --card: #0a0a0a; --green: #00ff00; --red: #ff3333; --gray: #1a1a1a; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: #fff; margin: 0; padding-bottom: 50px; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #000; border-bottom: 1px solid #222; position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: bold; font-size: 1.2rem; color: var(--main); }
        .balance-tag { background: rgba(138, 43, 226, 0.1); padding: 5px 15px; border-radius: 20px; color: var(--main); font-weight: bold; border: 1px solid var(--main); }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Full Screen */
        .buy-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .buy-modal.active { display: flex; }
        .m-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .m-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .m-input-card { background: #111; padding: 15px; border-radius: 20px; text-align: center; border: 1px solid #222; }
        .m-input-card label { display: block; color: #777; font-size: 0.8rem; margin-bottom: 5px; }
        .m-input-card input { background: transparent; border: none; color: #fff; text-align: center; width: 100%; font-size: 1.3rem; outline: none; font-weight: bold; }

        .id-box { background: #111; padding: 20px; border-radius: 25px; border: 1px solid #222; margin-bottom: 25px; }
        .id-box input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-size: 1.5rem; outline: none; }

        .m-footer { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-confirm { flex: 2; background: linear-gradient(45deg, #4b0082, #8a2be2); border: none; padding: 18px; border-radius: 30px; color: #fff; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .btn-close { flex: 1; background: transparent; border: 1px solid var(--red); color: var(--red); padding: 18px; border-radius: 30px; font-weight: bold; cursor: pointer; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .section-title { padding: 15px; font-size: 1.1rem; font-weight: bold; color: var(--main); }
        .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .prod-card { background: var(--card); border-radius: 15px; padding: 10px; text-align: center; border: 1px solid #1a1a1a; cursor: pointer; }
        .prod-card img { width: 100%; aspect-ratio: 1/1; border-radius: 12px; object-fit: cover; margin-bottom: 10px; }
        .prod-card h4 { margin: 5px 0; font-size: 0.9rem; height: 35px; overflow: hidden; }
        .prod-card b { color: var(--main); }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .adm-container { margin: 15px; background: #050505; border-radius: 20px; border: 1px solid var(--main); padding: 15px; }
        .adm-tabs { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 5px; }
        .t-btn { background: var(--gray); color: #fff; border: none; padding: 10px 18px; border-radius: 12px; white-space: nowrap; cursor: pointer; font-size: 0.85rem; }
        .t-btn.active { background: var(--main); font-weight: bold; }
        
        .order-card { background: #111; padding: 15px; border-radius: 15px; margin-bottom: 10px; border-right: 4px solid var(--main); }
        .u-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #111; margin-bottom: 5px; border-radius: 10px; }

        input[type="text"], input[type="number"], input[type="email"], input[type="password"] { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 10px; }
        .hidden { display: none !important; }
        .notice-text { color: #666; font-size: 0.8rem; line-height: 1.6; text-align: center; }
    </style>
</head>
<body>

<header>
    <div class="logo">ğŸ‘¤ <span id="uName">Ø²Ø§Ø¦Ø±</span></div>
    <div class="balance-tag" id="uBalance">0 Ø¬</div>
    <i class="fa-solid fa-gear" onclick="openAuth()" style="cursor:pointer"></i>
</header>

<div id="adminArea" class="hidden">
    <div class="adm-container">
        <div class="adm-tabs">
            <button class="t-btn active" onclick="showTab('tabOrders', this)">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ğŸ””</button>
            <button class="t-btn" onclick="showTab('tabUsers', this)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
            <button class="t-btn" onclick="showTab('tabProducts', this)">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
            <button class="t-btn" onclick="showTab('tabCharge', this)">Ø´Ø­Ù† Ø±ØµÙŠØ¯</button>
        </div>

        <div id="tabOrders" class="tab-content">
            <div id="ordersList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>

        <div id="tabUsers" class="tab-content hidden">
            <div id="usersList"></div>
        </div>

        <div id="tabProducts" class="tab-content hidden">
            <input type="text" id="pn" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="pp" placeholder="Ø§Ù„Ø³Ø¹Ø±">
            <input type="number" id="pq" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© (ÙƒÙˆÙŠÙ†Ø²)">
            <input type="file" id="pi" accept="image/*">
            <button class="btn-confirm" style="width:100%" onclick="addProd()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</button>
        </div>

        <div id="tabCharge" class="tab-content hidden">
            <input type="number" id="cid" placeholder="Ø§Ø¯Ø®Ù„ ID Ø§Ù„ÙˆÙƒÙŠÙ„">
            <button class="btn-confirm" style="width:100%; margin-bottom:10px;" onclick="findUser()">Ø¨Ø­Ø«</button>
            <div id="chargeBox" class="hidden">
                <p id="targetName"></p>
                <input type="number" id="cAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <button class="btn-confirm" style="width:100%; background:var(--green); color:#000;" onclick="confirmCharge()">Ø´Ø­Ù† Ø§Ù„Ø¢Ù†</button>
            </div>
        </div>
    </div>
</div>

<div id="storeArea">
    <div class="section-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
    <div class="products-grid" id="prodsGrid"></div>
</div>

<div id="buyModal" class="buy-modal">
    <div class="m-header">
        <span class="balance-tag" id="mPrice">0 Ø¬</span>
        <span style="font-weight: bold;"><i class="fa-solid fa-heart"></i> <span id="mName">--</span></span>
    </div>

    <div class="m-grid">
        <div class="m-input-card">
            <label>Ø§Ù„Ø¹Ø¯Ø¯ (ÙƒÙˆÙŠÙ†Ø²)</label>
            <input type="number" id="iQty" value="1" oninput="recalc()">
        </div>
        <div class="m-input-card">
            <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label>
            <div style="font-size:1.3rem; font-weight:bold;"><span id="totalTxt">0</span> Ø¬</div>
        </div>
    </div>

    <div class="id-box">
        <input type="text" id="iID" placeholder="Ø§Ø¯Ø®Ù„ ID Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‡Ù†Ø§">
    </div>

    <div class="m-footer">
        <button class="btn-confirm" onclick="submitOrder()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</button>
        <button class="btn-close" onclick="closeM()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div class="notice-text">
        âš ï¸ <b>ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…</b>: Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ¯ÙˆÙŠ ÙˆÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª Ù„Ù„ØªÙ†ÙÙŠØ°. <br>
        Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø±Ø³Ù…ÙŠØ© ÙŠØ­Ù…ÙŠ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.
    </div>
</div>

<div id="authModal" class="buy-modal" style="display:flex; justify-content:center; align-items:center;">
    <div style="width:100%; max-width:400px; padding:20px;">
        <h1 style="text-align:center; color:var(--main); margin-bottom:30px;">HELMY STORE</h1>
        <input type="email" id="ae" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="ap" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <input type="text" id="an" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)">
        <button class="btn-confirm" style="width:100%; margin-top:10px;" onclick="login()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†ØµØ©</button>
    </div>
</div>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAalmOWMUhvCi_PuFSUbXRpbe1hmGyer7s",
        authDomain: "karem-store.firebaseapp.com",
        databaseURL: "https://karem-store-default-rtdb.firebaseio.com",
        projectId: "karem-store",
        storageBucket: "karem-store.firebasestorage.app",
        messagingSenderId: "898294902448",
        appId: "1:898294902448:web:23cbee5afd72adcb67d575"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = null; let selP = null; let tMail = '';

    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));
        document.querySelectorAll('.t-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        btn.classList.add('active');
    }

    function closeM() { document.getElementById('buyModal').classList.remove('active'); }
    function openAuth() { document.getElementById('authModal').style.display = 'flex'; }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ---
    function login() {
        const e = document.getElementById('ae').value.replace(/\./g, '_').toLowerCase();
        const p = document.getElementById('ap').value;
        const n = document.getElementById('an').value;

        if(e === 'admin@karem_com' && p === '123456') {
            setup({ name: 'ÙƒØ±ÙŠÙ… (Ø§Ù„Ù…Ø¯ÙŠØ±)', email: e, role: 'admin', balance: 999999, uid: 'MASTER' });
        } else {
            db.ref('users/'+e).once('value', s => {
                if(s.exists()) {
                    if(s.val().pass === p) setup(s.val());
                    else alert("Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø®Ø·Ø£");
                } else {
                    const id = Math.floor(Math.random()*9000)+1000;
                    const u = { name: n, email: e, pass: p, balance: 0, role: 'user', uid: id };
                    db.ref('users/'+e).set(u);
                    db.ref('idMap/'+id).set(e);
                    setup(u);
                }
            });
        }
    }

    function setup(d) {
        user = d;
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('uName').innerText = d.name;
        db.ref('users/'+d.email+'/balance').on('value', s => {
            user.balance = s.val() || 0;
            document.getElementById('uBalance').innerText = user.balance + " Ø¬";
        });
        if(d.role === 'admin') {
            document.getElementById('adminArea').classList.remove('hidden');
            loadOrders(); loadUsers();
        }
        loadProds();
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
    function addProd() {
        const n = document.getElementById('pn').value;
        const p = Number(document.getElementById('pp').value);
        const q = Number(document.getElementById('pq').value);
        const f = document.getElementById('pi').files[0];
        const r = new FileReader();
        r.onload = e => db.ref('products').push({ n, p, q, img: e.target.result });
        r.readAsDataURL(f); alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
    }

    function loadProds() {
        db.ref('products').on('value', s => {
            const grid = document.getElementById('prodsGrid'); grid.innerHTML = "";
            s.forEach(p => {
                const d = p.val();
                grid.innerHTML += `<div class="prod-card" onclick='openBuy(${JSON.stringify(d)})'>
                    <img src="${d.img}"><h4>${d.n}</h4><b>${d.p} Ø¬</b>
                </div>`;
            });
        });
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ ---
    function openBuy(p) {
        if(!user) return openAuth();
        selP = p;
        document.getElementById('buyModal').classList.add('active');
        document.getElementById('mName').innerText = p.n;
        document.getElementById('mPrice').innerText = p.p + " Ø¬";
        document.getElementById('iQty').value = p.q;
        recalc();
    }

    function recalc() {
        const qty = Number(document.getElementById('iQty').value);
        const total = (qty / selP.q) * selP.p;
        document.getElementById('totalTxt').innerText = total.toFixed(2);
    }

    function submitOrder() {
        const id = document.getElementById('iID').value;
        const tot = Number(document.getElementById('totalTxt').innerText);
        if(!id) return alert("Ø§Ø¯Ø®Ù„ Ø§Ù„Ù€ ID");
        if(user.balance < tot) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ");

        // Ø®ØµÙ… Ù…Ø¤Ù‚Øª
        db.ref('users/'+user.email).update({ balance: (user.balance - tot).toFixed(2) });
        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨
        db.ref('orders').push({
            uName: user.name, uMail: user.email,
            prod: selP.n, qty: document.getElementById('iQty').value,
            total: tot, gameID: id, status: 'pending', time: new Date().toLocaleString()
        });
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
        closeM();
    }

    // --- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±: Ø·Ù„Ø¨Ø§Øª ÙˆØ£Ø¹Ø¶Ø§Ø¡ ---
    function loadOrders() {
        db.ref('orders').on('value', s => {
            const list = document.getElementById('ordersList'); list.innerHTML = "";
            s.forEach(o => {
                const d = o.val();
                if(d.status === 'pending') {
                    list.innerHTML += `<div class="order-card">
                        <b>${d.prod} (${d.qty})</b><br>Ø§Ù„ÙˆÙƒÙŠÙ„: ${d.uName}<br>
                        <span style="color:var(--green)">ID: ${d.gameID}</span><br>Ø§Ù„Ù…Ø¨Ù„Øº: ${d.total} Ø¬
                        <div style="margin-top:10px; display:flex; gap:10px;">
                            <button class="btn-confirm" style="padding:10px; font-size:0.8rem;" onclick="appr('${o.key}')">Ù…ÙˆØ§ÙÙ‚Ø© âœ…</button>
                            <button class="btn-close" style="padding:10px; font-size:0.8rem;" onclick="rejt('${o.key}','${d.uMail}',${d.total})">Ø±ÙØ¶ âŒ</button>
                        </div>
                    </div>`;
                }
            });
        });
    }

    function appr(k) { db.ref('orders/'+k).update({status:'done'}); alert("ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„"); }
    function rejt(k, m, a) {
        db.ref('users/'+m).once('value', s => {
            db.ref('users/'+m).update({ balance: (Number(s.val().balance) + a).toFixed(2) });
            db.ref('orders/'+k).update({status:'rejected'});
            alert("ØªÙ… Ø§Ù„Ø±ÙØ¶ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±ØµÙŠØ¯");
        });
    }

    function loadUsers() {
        db.ref('users').on('value', s => {
            const box = document.getElementById('usersList'); box.innerHTML = "";
            s.forEach(u => {
                box.innerHTML += `<div class="u-row">
                    <span>${u.val().name} (${u.val().role})</span>
                    <button onclick="delU('${u.key}')" style="background:red; color:#fff; border:none; border-radius:5px; padding:5px;">Ø­Ø°Ù</button>
                </div>`;
            });
        });
    }
    function delU(k) { if(confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ø¶ÙˆØŸ")) db.ref('users/'+k).remove(); }

    // --- Ø§Ù„Ø´Ø­Ù† ---
    function findUser() {
        const id = document.getElementById('cid').value;
        db.ref('idMap/'+id).once('value', s => {
            if(!s.exists()) return alert("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            tMail = s.val();
            db.ref('users/'+tMail).once('value', u => {
                document.getElementById('chargeBox').classList.remove('hidden');
                document.getElementById('targetName').innerText = "Ø§Ù„ÙˆÙƒÙŠÙ„: " + u.val().name;
            });
        });
    }
    function confirmCharge() {
        const a = Number(document.getElementById('cAmount').value);
        db.ref('users/'+tMail).transaction(curr => { if(curr) curr.balance = (Number(curr.balance)||0) + a; return curr; });
        alert("ØªÙ… Ø§Ù„Ø´Ø­Ù†");
    }
</script>
</body>
</html>
