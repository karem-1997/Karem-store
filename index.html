<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAREM STORE | PRO SYSTEM 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --main: #ff0000; --bg: #000; --card: #0d0d0d; --green: #00ff00; --gray: #1a1a1a; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.2s; }
        body { background: var(--bg); color: #fff; margin: 0; padding-bottom: 80px; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { background: #000; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--main); position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: 900; font-size: 1.5rem; color: var(--main); text-shadow: 0 0 8px var(--main); }

        /* Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„ */
        .u-card { background: var(--card); margin: 15px; padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--gray); border-right: 5px solid var(--main); }
        .u-card img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--main); object-fit: cover; }
        .u-info h3 { margin: 0; font-size: 1rem; }
        .u-info p { margin: 5px 0 0; color: var(--green); font-weight: bold; font-size: 1.1rem; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .prod-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .item-box { background: var(--card); border-radius: 15px; padding: 15px; text-align: center; border: 1px solid var(--gray); cursor: pointer; }
        .item-box:hover { border-color: var(--main); background: #150000; }
        .item-box img { width: 100%; aspect-ratio: 1/1; border-radius: 10px; object-fit: cover; }
        .item-box h4 { font-size: 0.8rem; margin: 8px 0; height: 35px; overflow: hidden; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .adm-panel { background: #050505; border: 2px solid var(--main); margin: 15px; padding: 15px; border-radius: 20px; }
        .tabs { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .tab-btn { background: var(--gray); color: #fff; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; white-space: nowrap; font-size: 0.8rem; }
        .tab-btn.active { background: var(--main); font-weight: bold; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 10px; }
        .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--main); color: #fff; }
        .btn-green { background: var(--green); color: #000; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
        .order-card { background: #111; padding: 10px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--green); font-size: 0.8rem; }
        .order-card b { color: var(--main); }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #0a0a0a; width: 100%; max-width: 400px; padding: 25px; border-radius: 25px; border: 1px solid #333; }

        .hidden { display: none !important; }
        .back-btn { background: var(--gray); color: #fff; padding: 8px 15px; border-radius: 10px; margin: 15px; display: inline-block; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="logo">KAREM STORE</div>
    <div id="uHead" class="hidden"><img id="hImg" src="" style="width:35px; height:35px; border-radius:50%; border:1px solid var(--main)"></div>
    <i class="fa-solid fa-user-lock" onclick="openAuth()"></i>
</header>

<div id="uArea" class="hidden">
    <div class="u-card">
        <img id="uImg" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
        <div class="u-info">
            <h3 id="un">--</h3>
            <p>Ø§Ù„Ù…Ø­ÙØ¸Ø©: <span id="ub">0</span> Ø¬</p>
            <small id="ui" style="color:#777"></small>
        </div>
    </div>
</div>

<div id="admArea" class="hidden">
    <div class="adm-panel">
        <div class="tabs">
            <button class="tab-btn active" onclick="tab('t1', this)">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
            <button class="tab-btn" onclick="tab('t2', this)">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
            <button class="tab-btn" onclick="tab('t3', this)">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
            <button class="tab-btn" onclick="tab('t4', this)">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ğŸ””</button>
            <button class="tab-btn" onclick="tab('t5', this)">Ø´Ø­Ù†</button>
        </div>

        <div id="t1" class="t-c">
            <input type="text" id="cn" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <input type="text" id="ci" placeholder="Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚Ø³Ù… (Ù…Ø«Ù„ fa-gamepad)">
            <button class="btn btn-main" onclick="addCat()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…</button>
        </div>

        <div id="t2" class="t-c hidden">
            <select id="cpList"></select>
            <input type="text" id="pn" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø«Ù„Ø§Ù‹ 1000 ÙƒÙˆÙŠÙ†Ø²)">
            <input type="number" id="pp" placeholder="Ø§Ù„Ø³Ø¹Ø± Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø©">
            <input type="file" id="pf" accept="image/*">
            <button class="btn btn-main" onclick="addProd()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</button>
        </div>

        <div id="t3" class="t-c hidden">
            <div id="usersList"></div>
        </div>

        <div id="t4" class="t-c hidden">
            <div id="ordersList">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
        </div>

        <div id="t5" class="t-c hidden">
            <input type="number" id="sid" placeholder="Ø§Ø¯Ø®Ù„ ID Ø§Ù„ÙˆÙƒÙŠÙ„">
            <button class="btn btn-green" onclick="findU()">Ø¨Ø­Ø«</button>
            <div id="rBox" class="hidden">
                <p id="rt"></p>
                <input type="number" id="ra" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <button class="btn btn-green" onclick="charge()">Ø´Ø­Ù† Ø±ØµÙŠØ¯</button>
            </div>
        </div>
    </div>
</div>

<div id="catsView"><div class="grid" id="catsBox"></div></div>
<div id="prodsView" class="hidden">
    <div class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</div>
    <h3 id="catTitle" style="padding:0 20px; color:var(--main)"></h3>
    <div class="prod-grid" id="prodsBox"></div>
</div>

<div id="buyModal" class="modal">
    <div class="modal-content">
        <h3 id="mt"></h3>
        <p>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©: <b id="mp"></b> Ø¬</p>
        <label>Ø­Ø¯Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© (ØªÙ„Ù‚Ø§Ø¦ÙŠ):</label>
        <input type="number" id="mq" value="1" min="1" oninput="recalc()">
        <h2 style="color:var(--green)">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="mtot">0</span> Ø¬</h2>
        <div id="bAct"></div>
        <button class="btn" onclick="closeM('buyModal')" style="margin-top:10px; background:#222; color:#fff;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div id="authModal" class="modal">
    <div class="modal-content">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <input type="text" id="rn" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)">
        <input type="email" id="re" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
        <input type="password" id="rp" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯">
        <button class="btn btn-main" onclick="auth()">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAalmOWMUhvCi_PuFSUbXRpbe1hmGyer7s",
        authDomain: "karem-store.firebaseapp.com",
        databaseURL: "https://karem-store-default-rtdb.firebaseio.com",
        projectId: "karem-store",
        storageBucket: "karem-store.firebasestorage.app",
        messagingSenderId: "898294902448",
        appId: "1:898294902448:web:23cbee5afd72adcb67d575"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = null; let selP = null; let tMail = '';

    function closeM(id) { document.getElementById(id).classList.remove('active'); }
    function openAuth() { document.getElementById('authModal').classList.add('active'); }
    function tab(id, b) {
        document.querySelectorAll('.t-c').forEach(c=>c.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden'); b.classList.add('active');
    }
    function goBack() { document.getElementById('catsView').classList.remove('hidden'); document.getElementById('prodsView').classList.add('hidden'); }

    // --- Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ---
    function auth() {
        const e = document.getElementById('re').value.replace(/\./g, '_').toLowerCase();
        const p = document.getElementById('rp').value;
        const n = document.getElementById('rn').value;

        if(e === 'admin@karem_com' && p === '123456') {
            login({ name: 'ÙƒØ±ÙŠÙ… (Ø§Ù„Ù…Ø¯ÙŠØ±)', email: e, uid: 'MASTER', role: 'admin', balance: 999999 }); return;
        }

        db.ref('users/'+e).once('value', s => {
            if(s.exists()) {
                if(s.val().pass === p) login(s.val());
                else alert("Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø®Ø·Ø£");
            } else {
                db.ref('lastID').transaction(c => {
                    const id = (c || 1000) + 1;
                    const u = { name: n, email: e, pass: p, balance: 0, uid: id, role: 'user' };
                    db.ref('users/'+e).set(u);
                    db.ref('idMap/'+id).set(e);
                    login(u); return id;
                });
            }
        });
    }

    function login(d) {
        user = d; closeM('authModal');
        document.getElementById('uArea').classList.remove('hidden');
        document.getElementById('uHead').classList.remove('hidden');
        document.getElementById('un').innerText = d.name;
        document.getElementById('ui').innerText = "ID: " + d.uid;
        db.ref('users/'+d.email+'/balance').on('value', s => {
            user.balance = s.val() || 0;
            document.getElementById('ub').innerText = user.balance;
        });
        if(d.role === 'admin') {
            document.getElementById('admArea').classList.remove('hidden');
            loadOrders();
            loadUsers();
        }
        loadCats();
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
    function addCat() {
        const n = document.getElementById('cn').value;
        const i = document.getElementById('ci').value || 'fa-box';
        db.ref('categories').push({ name: n, icon: i }); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
    }

    function loadCats() {
        db.ref('categories').on('value', s => {
            const box = document.getElementById('catsBox'); box.innerHTML = "";
            const sel = document.getElementById('cpList'); sel.innerHTML = "";
            s.forEach(c => {
                box.innerHTML += `<div class="item-box" onclick="openCat('${c.key}', '${c.val().name}')"><i class="fa-solid ${c.val().icon}" style="font-size:2rem; color:red;"></i><h3>${c.val().name}</h3></div>`;
                sel.innerHTML += `<option value="${c.key}">${c.val().name}</option>`;
            });
        });
    }

    function addProd() {
        const c = document.getElementById('cpList').value;
        const n = document.getElementById('pn').value;
        const p = document.getElementById('pp').value;
        const f = document.getElementById('pf').files[0];
        const r = new FileReader();
        r.onload = e => db.ref('products/'+c).push({ n, p: Number(p), img: e.target.result });
        r.readAsDataURL(f); alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
    }

    function openCat(id, name) {
        document.getElementById('catsView').classList.add('hidden');
        document.getElementById('prodsView').classList.remove('hidden');
        document.getElementById('catTitle').innerText = name;
        db.ref('products/'+id).on('value', s => {
            const box = document.getElementById('prodsBox'); box.innerHTML = "";
            s.forEach(p => {
                const pd = p.val();
                box.innerHTML += `<div class="item-box" onclick='openBuy(${JSON.stringify(pd)})'><img src="${pd.img}"><h4>${pd.n}</h4><b>${pd.p} Ø¬</b></div>`;
            });
        });
    }

    // --- Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ---
    function openBuy(p) {
        if(!user) return openAuth();
        selP = p; document.getElementById('buyModal').classList.add('active');
        document.getElementById('mt').innerText = p.n;
        document.getElementById('mp').innerText = p.p;
        document.getElementById('mq').value = 1; recalc();
    }

    function recalc() {
        const q = document.getElementById('mq').value;
        const tot = q * selP.p; // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù‡Ù†Ø§
        document.getElementById('mtot').innerText = tot;
        const btn = document.getElementById('bAct');
        if(user.balance >= tot) btn.innerHTML = `<button class="btn btn-green" onclick="doBuy(${tot},${q})">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ âœ…</button>`;
        else btn.innerHTML = `<button class="btn" style="background:#333" disabled>Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ</button>`;
    }

    function doBuy(t, q) {
        db.ref('users/'+user.email).update({ balance: user.balance - t });
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙŠØ±Ø§Ù‡ Ø§Ù„Ù…Ø¯ÙŠØ±
        db.ref('orders').push({
            uName: user.name,
            uID: user.uid,
            pName: selP.n,
            qty: q,
            total: t,
            date: new Date().toLocaleString()
        });
        alert("ØªÙ… Ø§Ù„Ø·Ù„Ø¨! Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯: " + (user.balance - t));
        closeM('buyModal');
    }

    // --- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±: Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ---
    function loadOrders() {
        db.ref('orders').on('value', s => {
            const list = document.getElementById('ordersList');
            list.innerHTML = "";
            if(!s.exists()) list.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª";
            s.forEach(o => {
                const d = o.val();
                list.innerHTML = `<div class="order-card">
                    <b>Ø·Ù„Ø¨ Ù…Ù†:</b> ${d.uName} (ID: ${d.uID})<br>
                    <b>Ø§Ù„Ù…Ù†ØªØ¬:</b> ${d.pName} | <b>Ø§Ù„ÙƒÙ…ÙŠØ©:</b> ${d.qty}<br>
                    <b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</b> ${d.total} Ø¬ | <b>Ø§Ù„ÙˆÙ‚Øª:</b> ${d.date}
                </div>` + list.innerHTML;
            });
        });
    }

    function loadUsers() {
        db.ref('users').on('value', s => {
            const box = document.getElementById('usersList'); box.innerHTML = "";
            s.forEach(u => {
                box.innerHTML += `<div class="order-card" style="border-left-color:red; display:flex; justify-content:space-between;">
                    <span>${u.val().name} (${u.val().role})</span>
                    <button onclick="delU('${u.key}')" style="background:red; color:#fff; border:none; border-radius:5px;">Ø­Ø°Ù</button>
                </div>`;
            });
        });
    }
    function delU(key) { if(confirm("Ø­Ø°ÙØŸ")) db.ref('users/'+key).remove(); }

    function findU() {
        const id = document.getElementById('sid').value;
        db.ref('idMap/'+id).once('value', s => {
            if(!s.exists()) return alert("Ø®Ø·Ø£");
            tMail = s.val();
            db.ref('users/'+tMail).once('value', u => {
                document.getElementById('rBox').classList.remove('hidden');
                document.getElementById('rt').innerText = "Ø§Ù„ÙˆÙƒÙŠÙ„: " + u.val().name;
            });
        });
    }
    function charge() {
        const a = Number(document.getElementById('ra').value);
        db.ref('users/'+tMail).once('value', s => {
            db.ref('users/'+tMail).update({ balance: (s.val().balance||0)+a });
            alert("ØªÙ… Ø§Ù„Ø´Ø­Ù†");
        });
    }

    loadCats();
</script>
</body>
</html>
