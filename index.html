<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAREM STORE | العودة للأصل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --main: #8a2be2; --bg: #000; --card: #0d0d0d; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: #fff; margin: 0; padding: 10px; }

        header { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #222; }
        .bal-tag { color: var(--main); font-weight: bold; border: 1px solid var(--main); padding: 5px 10px; border-radius: 10px; }

        /* شبكة المنتجات */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .card { background: var(--card); border-radius: 15px; padding: 10px; text-align: center; border: 1px solid #1a1a1a; }
        .card img { width: 100%; border-radius: 10px; }
        .card button { background: var(--main); color: #fff; border: none; width: 100%; padding: 8px; border-radius: 8px; margin-top: 10px; cursor: pointer; }

        /* مودال الشراء (اللي كان عاجبك) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; padding: 20px; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-box { background: #111; padding: 20px; border-radius: 20px; border: 1px solid var(--main); margin: auto; width: 100%; max-width: 400px; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 10px; outline: none; }
        .btn-buy { background: var(--main); color: #fff; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; font-size: 1.1rem; }

        /* لوحة التحكم للمدير */
        .admin-panel { background: #050505; border: 1px solid #333; border-radius: 15px; padding: 15px; margin-top: 30px; }
        .order-item { background: #111; padding: 10px; border-radius: 10px; margin-bottom: 10px; border-right: 4px solid var(--main); }
        .btn-ok { background: #00ff00; color: #000; border: none; padding: 5px 10px; border-radius: 5px; margin-left: 5px; }
        .btn-no { background: #ff0000; color: #fff; border: none; padding: 5px 10px; border-radius: 5px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold;">KAREM STORE</div>
    <div id="uInfo" class="hidden">
        <span id="uName">..</span> | <span class="bal-tag" id="uBal">0 ج</span>
    </div>
    <button id="loginBtn" onclick="openLogin()" style="background:var(--main); color:#fff; border:none; padding:5px 10px; border-radius:5px;">دخول</button>
</header>

<div class="grid" id="prodsBox"></div>

<div id="buyModal" class="modal">
    <div class="modal-box">
        <h3 id="mTitle" style="text-align: center; color: var(--main);"></h3>
        <label>الكمية المطلوبة:</label>
        <input type="number" id="qty" value="1000" oninput="recalc()">
        <p>الإجمالي المطلوب: <b id="tot" style="color:var(--main)">0</b> جنيه</p>
        <input type="text" id="pID" placeholder="ادخل ID اللاعب">
        <button class="btn-buy" onclick="sendOrder()">تأكيد وإرسال الطلب</button>
        <button onclick="closeM()" style="background:none; color:#777; border:none; width:100%; margin-top:10px;">إلغاء</button>
    </div>
</div>

<div id="adminArea" class="admin-panel hidden">
    <h3 style="color:var(--main)">لوحة التحكم (الطلبات الواردة)</h3>
    <div id="ordersList">لا توجد طلبات..</div>
    <hr>
    <h4>إضافة منتج جديد</h4>
    <input type="text" id="pn" placeholder="اسم المنتج">
    <input type="number" id="pp" placeholder="السعر">
    <input type="number" id="pq" placeholder="الكمية المعادلة">
    <input type="file" id="pi">
    <button onclick="addP()" style="width:100%; background:var(--main); border:none; padding:10px; color:#fff; border-radius:10px;">نشر</button>
</div>

<div id="loginModal" class="modal">
    <div class="modal-box">
        <h3 style="text-align: center;">تسجيل الدخول</h3>
        <input type="email" id="le" placeholder="الايميل">
        <input type="password" id="lp" placeholder="الباسورد">
        <button class="btn-buy" onclick="login()">دخول</button>
        <button onclick="closeM()" style="background:none; color:#777; border:none; width:100%; margin-top:10px;">إغلاق</button>
    </div>
</div>

<script>
    // --- إعدادات Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyAalmOWMUhvCi_PuFSUbXRpbe1hmGyer7s",
        authDomain: "karem-store.firebaseapp.com",
        databaseURL: "https://karem-store-default-rtdb.firebaseio.com",
        projectId: "karem-store",
        storageBucket: "karem-store.firebasestorage.app",
        messagingSenderId: "898294902448",
        appId: "1:898294902448:web:23cbee5afd72adcb67d575"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = null; let selP = null;

    function closeM() { document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active')); }
    function openLogin() { document.getElementById('loginModal').classList.add('active'); }

    // --- تسجيل الدخول ---
    function login() {
        const e = document.getElementById('le').value.replace(/\./g, '_').toLowerCase();
        const p = document.getElementById('lp').value;

        if(e === 'admin@karem_com' && p === '123456') {
            setup({ name: 'المدير', email: e, role: 'admin', balance: 999999 });
        } else {
            db.ref('users/'+e).once('value', s => {
                if(s.exists() && s.val().pass === p) setup(s.val());
                else if(!s.exists()) {
                    const u = { name: 'وكيل جديد', email: e, pass: p, balance: 0, role: 'user' };
                    db.ref('users/'+e).set(u); setup(u);
                } else alert("خطأ!");
            });
        }
    }

    function setup(d) {
        user = d; closeM();
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('uInfo').classList.remove('hidden');
        document.getElementById('uName').innerText = d.name;
        db.ref('users/'+d.email+'/balance').on('value', s => {
            user.balance = s.val() || 0;
            document.getElementById('uBal').innerText = user.balance + " ج";
        });
        if(d.role === 'admin') {
            document.getElementById('adminArea').classList.remove('hidden');
            loadOrders();
        }
    }

    // --- المتجر والأسعار ---
    function addP() {
        const n = document.getElementById('pn').value;
        const p = Number(document.getElementById('pp').value);
        const q = Number(document.getElementById('pq').value);
        const r = new FileReader();
        r.onload = e => db.ref('products').push({ n, p, q, img: e.target.result });
        r.readAsDataURL(document.getElementById('pi').files[0]); alert("تم!");
    }

    function loadProds() {
        db.ref('products').on('value', s => {
            const box = document.getElementById('prodsBox'); box.innerHTML = "";
            s.forEach(p => {
                const d = p.val();
                box.innerHTML += `<div class="card">
                    <img src="${d.img}">
                    <h4>${d.n}</h4>
                    <b>${d.p} ج</b>
                    <button onclick='openBuy(${JSON.stringify(d)})'>شراء</button>
                </div>`;
            });
        });
    }

    function openBuy(p) {
        if(!user) return openLogin();
        selP = p;
        document.getElementById('buyModal').classList.add('active');
        document.getElementById('mTitle').innerText = p.n;
        document.getElementById('qty').value = p.q;
        recalc();
    }

    function recalc() {
        const q = document.getElementById('qty').value;
        const total = (q / selP.q) * selP.p;
        document.getElementById('tot').innerText = total.toFixed(2);
    }

    function sendOrder() {
        const id = document.getElementById('pID').value;
        const total = Number(document.getElementById('tot').innerText);
        if(!id) return alert("ادخل ID");
        if(user.balance < total) return alert("رصيدك لا يكفي");

        // خصم مؤقت
        db.ref('users/'+user.email).update({ balance: (user.balance - total).toFixed(2) });
        // إرسال طلب للمدير
        db.ref('orders').push({
            uName: user.name, uMail: user.email, prod: selP.n, qty: document.getElementById('qty').value,
            total: total, gameID: id, status: 'pending'
        });
        alert("تم الإرسال للمدير"); closeM();
    }

    // --- لوحة المدير ---
    function loadOrders() {
        db.ref('orders').on('value', s => {
            const list = document.getElementById('ordersList'); list.innerHTML = "";
            s.forEach(o => {
                const d = o.val();
                if(d.status === 'pending') {
                    list.innerHTML += `<div class="order-item">
                        <b>${d.prod} - ${d.qty} كوينز</b><br>الوكيل: ${d.uName} | ID: ${d.gameID}<br>
                        السعر: ${d.total} ج<br>
                        <button class="btn-ok" onclick="appr('${o.key}')">موافقة ✅</button>
                        <button class="btn-no" onclick="rejt('${o.key}','${d.uMail}',${d.total})">رفض ❌</button>
                    </div>`;
                }
            });
        });
    }

    function appr(k) { db.ref('orders/'+k).update({status:'done'}); }
    function rejt(k, m, a) {
        db.ref('users/'+m).once('value', s => {
            db.ref('users/'+m).update({ balance: (Number(s.val().balance) + a).toFixed(2) });
            db.ref('orders/'+k).update({status:'rejected'});
        });
    }

    loadProds();
</script>
</body>
</html>
