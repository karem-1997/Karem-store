<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helmy Card - Multi-System Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        :root { --gold: linear-gradient(135deg, #bf953f 0%, #fcf6ba 45%, #b38728 70%, #fbf5b7 100%); --bg: #050505; --card-bg: #0d0d0d; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .header-title { font-size: 35px; font-weight: 900; background: var(--gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; margin-bottom: 20px; }
        
        /* ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ */
        .tabs-container { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px; }
        .tab-btn { background: #1a1a1a; color: #888; border: 1px solid #333; padding: 12px 20px; border-radius: 15px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--gold); color: #000; border: none; }

        .main-card { background: var(--card-bg); border: 1px solid rgba(191,149,63,0.3); border-radius: 30px; padding: 25px; width: 100%; max-width: 480px; box-shadow: 0 20px 40px rgba(0,0,0,0.8); display: none; }
        .copy-box { background: rgba(191,149,63,0.08); border: 1px dashed #bf953f; border-radius: 15px; padding: 15px; text-align: center; margin-bottom: 20px; cursor: pointer; }
        
        .input-group { margin-bottom: 18px; text-align: right; }
        label { display: block; margin-bottom: 8px; font-size: 13px; color: #fcf6ba; font-weight: bold; }
        input, select { width: 100%; background: #151515; border: 1px solid rgba(191,149,63,0.2); border-radius: 12px; padding: 14px; color: white; outline: none; box-sizing: border-box; }
        
        .calc-box { background: rgba(191,149,63,0.05); padding: 20px; border-radius: 20px; text-align: center; margin: 15px 0; border: 1px solid rgba(191,149,63,0.15); }
        .calc-value { font-size: 28px; font-weight: 900; }

        .btn-submit { width: 100%; padding: 18px; background: var(--gold); border: none; border-radius: 15px; color: #000; font-size: 18px; font-weight: 900; cursor: pointer; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        #adminPanel { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 9999; padding: 20px; overflow-y: auto; }
        .admin-box { background: #0a0a0a; border: 2px solid #bf953f; border-radius: 25px; max-width: 600px; margin: auto; padding: 25px; }
        .admin-section { background: #111; padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #222; }
        .agent-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 10px; }
        .btn-del { background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

<h1 class="header-title" onclick="openAdmin()">Helmy Card</h1>

<div class="tabs-container" id="navTabs"></div>

<div class="main-card" id="userUI">
    <div style="text-align:center;">
        <p id="u_warn" style="color:#ff4d4d; font-size:12px; font-weight:bold;"></p>
        <div class="copy-box" onclick="copyValue('u_aid')">
            ID Ø§Ù„Ø³Ø­Ø¨: <b id="u_aid"></b><br>
            Ø§Ù„Ù…Ø³ØªÙ„Ù…: <b id="u_aname"></b>
        </div>
    </div>

    <div class="input-group"><label id="l_uid">Ø§Ù„Ø£ÙŠØ¯ÙŠ</label><input type="text" id="i_uid"></div>
    
    <div class="input-group">
        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨</label>
        <select id="i_method" onchange="toggleAgentView(); calculate();">
            <option value="cash">ÙƒØ§Ø´ (ÙÙˆØ¯Ø§ÙÙˆÙ†/Ø§ØªØµØ§Ù„Ø§Øª/Ø£ÙˆØ±Ù†Ø¬)</option>
            <option value="agent_vip">ÙˆÙƒÙŠÙ„ Ù…Ø³Ø¬Ù„ (Ø³Ø¹Ø± Ø®Ø§Øµ) ğŸ”½</option>
        </select>
    </div>

    <div class="input-group" id="agent_area" style="display:none;">
        <label>Ø§Ø®ØªØ± Ø§Ù„ÙˆÙƒÙŠÙ„</label>
        <select id="i_agent_list" onchange="calculate()"></select>
    </div>

    <div class="input-group">
        <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± ($)</label>
        <input type="number" id="i_usd" placeholder="0.00" oninput="calculate()">
    </div>

    <div class="calc-box">
        <div id="rate_info" style="font-size:11px; color:gold; margin-bottom:5px;">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù: 0</div>
        <div class="calc-value" id="res_egp">0.00 Ø¬.Ù…</div>
    </div>

    <div class="input-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©</label><input type="text" id="i_wallet" placeholder="01xxxxxxxxx"></div>
    <div class="input-group"><label>Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„</label><input type="file" id="i_file" accept="image/*"></div>

    <button class="btn-submit" onclick="sendOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ğŸš€</button>
</div>

<div id="adminPanel">
    <div class="admin-box">
        <h2 style="text-align:center; color:gold;">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø© âš™ï¸</h2>
        
        <div class="admin-section" style="border-color:#22c55e;">
            <label>Ø¥Ø¶Ø§ÙØ© ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯</label>
            <input type="text" id="new_app_name" placeholder="Ù…Ø«Ø§Ù„: Ù„ÙŠÙÙ„Ø²">
            <button class="btn-submit" style="margin-top:10px; font-size:14px; padding:10px;" onclick="addApp()">Ø£Ù†Ø´Ø¦ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¢Ù†</button>
        </div>

        <div id="editArea" style="display:none;">
            <h3 style="color:gold;">ØªØ¹Ø¯ÙŠÙ„: <span id="target_name"></span></h3>
            <div class="admin-section">
                <label>Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ (API)</label>
                <input type="text" id="a_sheet" placeholder="Ø±Ø§Ø¨Ø· SheetDB" style="margin-bottom:8px;">
                <input type="text" id="a_token" placeholder="ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª" style="margin-bottom:8px;">
                <input type="text" id="a_chat" placeholder="Chat ID">
            </div>
            <div class="admin-section">
                <label>Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø©</label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <input type="number" step="0.1" id="a_rv" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙƒØ§Ø´">
                    <input type="number" step="0.1" id="a_ra" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆÙƒÙŠÙ„">
                </div>
            </div>
            <div class="admin-section">
                <label>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø¨</label>
                <input type="text" id="a_aid" placeholder="ID Ø§Ù„Ø³Ø­Ø¨" style="margin-bottom:8px;">
                <input type="text" id="a_aname" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…" style="margin-bottom:8px;">
                <input type="text" id="a_warn" placeholder="Ù†Øµ Ø§Ù„ØªØ­Ø°ÙŠØ±">
            </div>
            <div class="admin-section">
                <label>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡ Ø§Ù„Ù…Ø®ØµØµÙŠÙ† (ID | Ø§Ù„Ø§Ø³Ù… | Ø§Ù„Ø³Ø¹Ø±)</label>
                <div id="agents_list"></div>
                <button onclick="addAgentRow()" style="width:100%; background:#333; color:white; border:none; padding:8px; border-radius:8px; cursor:pointer;">+ Ø¥Ø¶Ø§ÙØ© ÙˆÙƒÙŠÙ„ VIP</button>
            </div>
            <button class="btn-submit" onclick="saveData()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª âœ…</button>
            <button onclick="deleteApp()" style="width:100%; background:red; color:white; border:none; margin-top:10px; padding:10px; border-radius:10px; cursor:pointer;">Ø­Ø°Ù Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ğŸ—‘ï¸</button>
        </div>
        <button onclick="document.getElementById('adminPanel').style.display='none'" style="width:100%; background:#222; color:#fff; border:none; margin-top:15px; padding:12px; border-radius:15px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDp1PmSbyiyP-cEZyPy9sK3FnKKKhbnJKQ",
        authDomain: "karak-13101.firebaseapp.com",
        projectId: "karak-13101",
        databaseURL: "https://karak-13101-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let apps = {}; let active = "";

    // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.ref('System_V9').on('value', (s) => {
        apps = s.val() || {};
        renderTabs();
        if(!active && Object.keys(apps).length > 0) selectApp(Object.keys(apps)[0]);
        else if(active) selectApp(active);
    });

    function renderTabs() {
        const nav = document.getElementById('navTabs'); nav.innerHTML = '';
        for(let n in apps) {
            const b = document.createElement('button');
            b.className = `tab-btn ${active === n ? 'active' : ''}`;
            b.innerText = n; b.onclick = () => selectApp(n);
            nav.appendChild(b);
        }
    }

    function selectApp(n) {
        active = n; const d = apps[n];
        document.getElementById('userUI').style.display = 'block';
        document.getElementById('u_warn').innerText = d.warn || "";
        document.getElementById('u_aid').innerText = d.aid || "";
        document.getElementById('u_aname').innerText = d.aname || "";
        
        const vSel = document.getElementById('i_agent_list');
        vSel.innerHTML = '<option value="general">ÙˆÙƒÙŠÙ„ Ø¹Ø§Ù… (Ø³Ø¹Ø± Ù…ÙˆØ­Ø¯)</option>';
        if(d.agents) {
            for(let id in d.agents) {
                let o = document.createElement('option');
                o.value = id; o.text = `${d.agents[id].name} (${id})`;
                vSel.add(o);
            }
        }
        renderTabs(); calculate();
    }

    function calculate() {
        if(!active) return; const d = apps[active];
        const usd = parseFloat(document.getElementById('i_usd').value) || 0;
        const method = document.getElementById('i_method').value;
        let rate = d.rv || 0;

        if(method === 'agent_vip') {
            const vId = document.getElementById('i_agent_list').value;
            rate = (vId !== 'general' && d.agents[vId]) ? d.agents[vId].price : d.ra;
        }

        document.getElementById('rate_info').innerText = "Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±: " + rate;
        document.getElementById('res_egp').innerText = (usd * rate).toFixed(2) + " Ø¬.Ù…";
        return (usd * rate).toFixed(2);
    }

    function toggleAgentView() { document.getElementById('agent_area').style.display = (document.getElementById('i_method').value === 'agent_vip') ? 'block' : 'none'; }

    function openAdmin() {
        if(prompt("Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯:") !== "1997") return;
        document.getElementById('adminPanel').style.display = 'block';
        if(active) {
            const d = apps[active];
            document.getElementById('target_name').innerText = active;
            document.getElementById('a_sheet').value = d.sheet || "";
            document.getElementById('a_token').value = d.token || "";
            document.getElementById('a_chat').value = d.chatid || "";
            document.getElementById('a_rv').value = d.rv || "";
            document.getElementById('a_ra').value = d.ra || "";
            document.getElementById('a_aid').value = d.aid || "";
            document.getElementById('a_aname').value = d.aname || "";
            document.getElementById('a_warn').value = d.warn || "";
            
            const list = document.getElementById('agents_list'); list.innerHTML = '';
            if(d.agents) { for(let id in d.agents) addAgentRow(id, d.agents[id].name, d.agents[id].price); }
            document.getElementById('editArea').style.display = 'block';
        }
    }

    function addAgentRow(id="", name="", price="") {
        const div = document.createElement('div'); div.className = 'agent-row';
        div.innerHTML = `<input type="text" class="v-id" value="${id}" placeholder="ID"><input type="text" class="v-name" value="${name}" placeholder="Ø§Ù„Ø§Ø³Ù…"><input type="number" class="v-price" value="${price}" placeholder="Ø§Ù„Ø³Ø¹Ø±"><button class="btn-del" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('agents_list').appendChild(div);
    }

    function addApp() {
        const n = document.getElementById('new_app_name').value; if(!n) return;
        db.ref('System_V9/' + n).set({ rv: 45, ra: 46, aid: "000", aname: "Admin" });
    }

    function saveData() {
        const ags = {};
        document.querySelectorAll('.agent-row').forEach(r => {
            const id = r.querySelector('.v-id').value;
            if(id) ags[id] = { name: r.querySelector('.v-name').value, price: parseFloat(r.querySelector('.v-price').value) };
        });
        const up = {
            sheet: document.getElementById('a_sheet').value,
            token: document.getElementById('a_token').value,
            chatid: document.getElementById('a_chat').value,
            rv: parseFloat(document.getElementById('a_rv').value),
            ra: parseFloat(document.getElementById('a_ra').value),
            aid: document.getElementById('a_aid').value,
            aname: document.getElementById('a_aname').value,
            warn: document.getElementById('a_warn').value,
            agents: ags
        };
        db.ref('System_V9/' + active).update(up).then(() => alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…"));
    }

    function deleteApp() { if(confirm("Ø­Ø°Ù Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŸ")) db.ref('System_V9/' + active).remove(); }
    function copyValue(id) { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…"); }

    async function sendOrder() {
        const file = document.getElementById('i_file').files[0];
        const uid = document.getElementById('i_uid').value;
        const config = apps[active];
        if(!file || !uid || !config.token) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");

        const egp = calculate();
        const now = new Date();
        const day = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"][now.getDay()];
        const dateStr = now.toLocaleDateString('en-GB');

        let agentName = "ÙƒØ§Ø´";
        if(document.getElementById('i_method').value === 'agent_vip') {
            const vId = document.getElementById('i_agent_list').value;
            agentName = (vId !== 'general') ? config.agents[vId].name : "ÙˆÙƒÙŠÙ„ Ø¹Ø§Ù…";
        }

        // ØªÙ„ÙŠØ¬Ø±Ø§Ù…
        const fd = new FormData();
        fd.append('chat_id', config.chatid); fd.append('photo', file);
        fd.append('caption', `ğŸ“¦ Ø·Ù„Ø¨: ${active}\nğŸ†” Ø§Ù„Ø£ÙŠØ¯ÙŠ: ${uid}\nğŸ‘¤ Ø§Ù„ÙˆÙƒÙŠÙ„: ${agentName}\nğŸ’µ Ø¯ÙˆÙ„Ø§Ø±: ${document.getElementById('i_usd').value}$\nğŸ‡ªğŸ‡¬ Ù…ØµØ±ÙŠ: ${egp}\nğŸ¦ Ø§Ù„Ù…Ø­ÙØ¸Ø©: ${document.getElementById('i_wallet').value}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}`);
        
        // Ø¥ÙƒØ³Ù„ (SheetDB)
        fetch(config.sheet, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: [{
                "Ø§Ù„Ø£ÙŠØ¯ÙŠ": uid, "Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„": agentName, "Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±": document.getElementById('i_usd').value,
                "Ø§Ù„Ù…ØµØ±ÙŠ": egp, "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨": document.getElementById('i_method').value,
                "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©": "'" + document.getElementById('i_wallet').value, "Ø§Ù„ÙŠÙˆÙ…": day, "Ø§Ù„ØªØ§Ø±ÙŠØ®": dateStr
            }]})
        });

        await fetch(`https://api.telegram.org/bot${config.token}/sendPhoto`, { method: 'POST', body: fd });
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…"); location.reload();
    }
</script>
</body>
</html>
