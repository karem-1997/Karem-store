<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAREM STORE | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --main: #ff0000; --bg: #050505; --card: #121212; --text: #ffffff; --green: #2ecc71; --gray: #222; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { background: #000; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gray); position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: 900; font-size: 1.4rem; color: var(--main); }
        .user-stats { text-align: left; font-size: 0.8rem; }

        /* Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± */
        .slider { width: 95%; height: 160px; margin: 10px auto; border-radius: 15px; overflow: hidden; position: relative; border: 1px solid var(--gray); }
        .slides { display: flex; transition: 0.5s; height: 100%; }
        .slides img { min-width: 100%; object-fit: cover; }

        /* Ø§Ù„Ù…ØªØ¬Ø± */
        .section-header { padding: 15px; font-weight: bold; color: var(--main); font-size: 1.1rem; border-right: 4px solid var(--main); margin: 10px 15px; background: #0f0f0f; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 15px; }
        .item-card { background: var(--card); border-radius: 12px; border: 1px solid var(--gray); padding: 8px; text-align: center; position: relative; }
        .item-card img { width: 100%; border-radius: 8px; aspect-ratio: 1/1; object-fit: cover; }
        .item-card h4 { font-size: 0.75rem; margin: 8px 0; height: 35px; overflow: hidden; color: #eee; }
        .item-card b { color: var(--green); font-size: 0.85rem; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .admin-box { background: #0a0a0a; border: 1px solid var(--main); margin: 15px; padding: 15px; border-radius: 15px; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; transition: 0.3s; }
        .btn-main { background: var(--main); color: #fff; }
        .btn-buy { background: var(--green); color: #000; }
        
        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #111; width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; border: 1px solid #333; }

        .hidden { display: none !important; }
        .side-menu { position: fixed; top: 0; right: -100%; width: 80%; height: 100%; background: #000; z-index: 3000; transition: 0.3s; padding: 20px; border-left: 1px solid var(--gray); }
        .side-menu.active { right: 0; }
    </style>
</head>
<body>

<header>
    <div class="logo">KAREM STORE</div>
    <div id="topStats" class="user-stats hidden">
        <span id="headBal" style="color:var(--green)">0</span> Ø¬<br>
        <span id="headID" style="color:#888">ID: --</span>
    </div>
    <i class="fa-solid fa-bars-staggered" style="font-size: 1.5rem;" onclick="toggleMenu()"></i>
</header>

<div class="slider">
    <div class="slides" id="sliderContainer">
        <img src="https://img.freepik.com/premium-photo/gaming-banner-design_1143431-13.jpg">
    </div>
</div>

<div id="adminPanel" class="hidden">
    <div class="admin-box">
        <h3 style="color:var(--main); margin:0 0 10px;">ğŸ› ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØµØ©</h3>
        <div id="adminTabs">
            <button class="btn btn-main" onclick="openAdminTab('addP')">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
            <button class="btn btn-main" onclick="openAdminTab('orders')">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</button>
            <button class="btn btn-main" onclick="openAdminTab('users')">Ø´Ø­Ù† Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</button>
        </div>

        <div id="addP" class="admin-tab hidden">
            <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="pPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©">
            <select id="pCat">
                <option value="games">Ø§Ù„Ø¹Ø§Ø¨</option>
                <option value="apps">Ø¨Ø±Ø§Ù…Ø¬</option>
            </select>
            <input type="file" id="pFile" accept="image/*">
            <button class="btn btn-buy" onclick="uploadProduct()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
        </div>

        <div id="orders" class="admin-tab hidden">
            <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</h4>
            <div id="ordersList" style="font-size:0.8rem;"></div>
        </div>

        <div id="users" class="admin-tab hidden">
            <input type="number" id="targetID" placeholder="ID Ø§Ù„ÙˆÙƒÙŠÙ„">
            <button class="btn btn-main" onclick="searchAgent()">Ø¨Ø­Ø«</button>
            <div id="agentInfo" class="hidden">
                <p id="agentDetail"></p>
                <input type="number" id="addAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <button class="btn btn-buy" onclick="confirmCharge()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯</button>
            </div>
        </div>
    </div>
</div>

<div id="storeView">
    <div class="section-header">ğŸ® Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
    <div class="grid" id="gamesGrid"></div>
    <div class="section-header">ğŸ“± Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬</div>
    <div class="grid" id="appsGrid"></div>
</div>

<div id="buyModal" class="modal">
    <div class="modal-content">
        <h3 id="buyTitle">--</h3>
        <p>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©: <span id="unitPrice">0</span> Ø¬</p>
        <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</label>
        <input type="number" id="buyQty" value="1" min="1" oninput="calcTotal()">
        <div style="margin: 15px 0; font-size: 1.2rem;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="totalPrice" style="color:var(--green)">0</b> Ø¬</div>
        <div id="buyAction"></div>
        <button class="btn" style="background:#333; color:#fff;" onclick="closeModal('buyModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div class="side-menu" id="sideMenu">
    <div id="guestMenu">
        <button class="btn btn-main" onclick="openAuth()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </div>
    <div id="userMenu" class="hidden">
        <h3 id="menuName">--</h3>
        <p id="menuID"></p>
        <button class="btn" style="background:#333; color:white; margin-top:50px;" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<div id="authModal" class="modal">
    <div class="modal-content">
        <h3 id="authTitle">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</h3>
        <input type="text" id="regName" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù„Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯)">
        <input type="email" id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="regPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-main" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" style="background:transparent; border:1px solid #444; color:#fff" onclick="closeModal('authModal')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAalmOWMUhvCi_PuFSUbXRpbe1hmGyer7s",
        authDomain: "karem-store.firebaseapp.com",
        databaseURL: "https://karem-store-default-rtdb.firebaseio.com",
        projectId: "karem-store",
        storageBucket: "karem-store.firebasestorage.app",
        messagingSenderId: "898294902448",
        appId: "1:898294902448:web:23cbee5afd72adcb67d575",
        measurementId: "G-V56WJVTN4J"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = null;
    let selectedItem = null;
    let foundEmail = '';

    function toggleMenu() { document.getElementById('sideMenu').classList.toggle('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openAuth() { document.getElementById('authModal').classList.add('active'); toggleMenu(); }
    function openAdminTab(id) {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    function handleAuth() {
        const email = document.getElementById('regEmail').value.replace(/\./g, '_').toLowerCase();
        const pass = document.getElementById('regPass').value;
        const name = document.getElementById('regName').value;

        if(email === 'admin@karem_com' && pass === '123456') {
            const admin = { name: 'ÙƒØ±ÙŠÙ… (Ø§Ù„Ù…Ø¯ÙŠØ±)', email, uid: 1001, role: 'admin', balance: 0 };
            login(admin); return;
        }

        db.ref('users/' + email).once('value', snap => {
            if(snap.exists()) {
                if(snap.val().pass === pass) login(snap.val());
                else alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
            } else {
                db.ref('lastID').transaction(c => {
                    const next = (c || 1000) + 1;
                    const u = { name, email, pass, balance:0, uid:next, role:'user' };
                    db.ref('users/'+email).set(u);
                    db.ref('idMap/'+next).set(email);
                    login(u); return next;
                });
            }
        });
    }

    function login(d) {
        user = d;
        closeModal('authModal');
        document.getElementById('topStats').classList.remove('hidden');
        document.getElementById('guestMenu').classList.add('hidden');
        document.getElementById('userMenu').classList.remove('hidden');
        document.getElementById('menuName').innerText = d.name;
        document.getElementById('menuID').innerText = "ID: " + d.uid;
        document.getElementById('headID').innerText = "ID: " + d.uid;
        
        db.ref('users/'+d.email+'/balance').on('value', s => {
            user.balance = s.val() || 0;
            document.getElementById('headBal').innerText = user.balance;
        });
        
        if(d.role === 'admin') {
            document.getElementById('adminPanel').classList.remove('hidden');
            listenOrders();
        }
        renderStore();
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ ---
    function renderStore() {
        ['games', 'apps'].forEach(cat => {
            db.ref('products/'+cat).on('value', snap => {
                const grid = document.getElementById(cat+'Grid');
                grid.innerHTML = "";
                snap.forEach(s => {
                    const p = s.val();
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `<img src="${p.img}"><h4>${p.n}</h4><b>${p.p} Ø¬</b>`;
                    card.onclick = () => openBuy(p, s.key, cat);
                    grid.appendChild(card);
                });
            });
        });
    }

    function openBuy(p, key, cat) {
        if(!user) return openAuth();
        selectedItem = { ...p, key, cat };
        document.getElementById('buyModal').classList.add('active');
        document.getElementById('buyTitle').innerText = p.n;
        document.getElementById('unitPrice').innerText = p.p;
        document.getElementById('buyQty').value = 1;
        calcTotal();
    }

    function calcTotal() {
        const qty = document.getElementById('buyQty').value;
        const total = qty * selectedItem.p;
        document.getElementById('totalPrice').innerText = total;
        
        const actionDiv = document.getElementById('buyAction');
        if(user.balance >= total) {
            actionDiv.innerHTML = `<button class="btn btn-buy" onclick="confirmPurchase(${total}, ${qty})">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù† âœ…</button>`;
        } else {
            actionDiv.innerHTML = `<button class="btn btn-main" onclick="alert('ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ø´Ø­Ù† Ø±ØµÙŠØ¯Ùƒ')">Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ - Ø§Ø´Ø­Ù† Ø§Ù„Ø¢Ù† âš ï¸</button>`;
        }
    }

    function confirmPurchase(total, qty) {
        if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ ${qty} Ù…Ù† ${selectedItem.n} Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${total} Ø¬ØŸ`)) {
            const newBal = user.balance - total;
            db.ref('users/'+user.email).update({ balance: newBal });
            db.ref('orders').push({
                uName: user.name,
                uID: user.uid,
                pName: selectedItem.n,
                qty: qty,
                total: total,
                time: new Date().toLocaleString()
            });
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
            closeModal('buyModal');
        }
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¯ÙŠØ± ---
    function uploadProduct() {
        const n = document.getElementById('pName').value;
        const p = document.getElementById('pPrice').value;
        const c = document.getElementById('pCat').value;
        const file = document.getElementById('pFile').files[0];
        if(!n || !p || !file) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        const r = new FileReader();
        r.onload = e => db.ref('products/'+c).push({ n, p: Number(p), img: e.target.result });
        r.readAsDataURL(file);
        alert("ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }

    function listenOrders() {
        db.ref('orders').on('value', snap => {
            const list = document.getElementById('ordersList');
            list.innerHTML = "";
            snap.forEach(s => {
                const o = s.val();
                list.innerHTML += `<div style="border:1px solid #333; padding:5px; margin-bottom:5px;">
                    <b>${o.uName} (${o.uID})</b> Ø§Ø´ØªØ±Ù‰ ${o.qty} Ù…Ù† ${o.pName} <br> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${o.total} Ø¬ <br> <small>${o.time}</small>
                    <button onclick="this.parentElement.remove()" style="background:red; color:#fff; border:none; padding:2px 5px; border-radius:5px; float:left;">Ø­Ø°Ù</button>
                </div>`;
            });
        });
    }

    function searchAgent() {
        const id = document.getElementById('targetID').value;
        db.ref('idMap/'+id).once('value', snap => {
            if(!snap.exists()) return alert("ID ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            foundEmail = snap.val();
            db.ref('users/'+foundEmail).once('value', s => {
                document.getElementById('agentInfo').classList.remove('hidden');
                document.getElementById('agentDetail').innerText = "Ø§Ù„ÙˆÙƒÙŠÙ„: " + s.val().name + " | Ø±ØµÙŠØ¯Ù‡: " + s.val().balance;
            });
        });
    }

    function confirmCharge() {
        const amt = Number(document.getElementById('addAmt').value);
        db.ref('users/'+foundEmail).once('value', s => {
            db.ref('users/'+foundEmail).update({ balance: (s.val().balance || 0) + amt });
            alert("ØªÙ… Ø§Ù„Ø´Ø­Ù†!");
            document.getElementById('agentResult').classList.add('hidden');
        });
    }

    // ØªØ´ØºÙŠÙ„ Ø¹Ø§Ù…
    renderStore();
</script>
</body>
</html>
