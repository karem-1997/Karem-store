<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAREM STORE | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        :root { --bg: #050505; --card: #121212; --accent: #ff0000; --green: #2ecc71; --blue: #3498db; --gray: #222; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; margin: 0; padding-bottom: 100px; overflow-x: hidden; }

        header { background: #000; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gray); position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: 900; font-size: 1.3rem; color: var(--accent); letter-spacing: 1px; }
        
        /* Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± */
        .slider { width: 100%; height: 180px; position: relative; overflow: hidden; background: #000; margin-bottom: 10px; }
        .slider-wrap { display: flex; transition: 0.5s; height: 100%; }
        .slider-wrap img { min-width: 100%; height: 100%; object-fit: cover; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        .btn { padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; margin-top: 10px; }
        .btn-main { background: var(--accent); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--gray); color: white; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid var(--gray); color: white; border-radius: 10px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
        .admin-section { background: #0a0a0a; border: 1px solid #333; margin: 15px; padding: 15px; border-radius: 15px; }
        .admin-tab { display: none; margin-top: 15px; }
        .admin-tab.active { display: block; }
        .tab-btn { background: #111; color: #888; padding: 8px 15px; border-radius: 8px; font-size: 0.8rem; border: 1px solid #222; margin-left: 5px; cursor: pointer; }
        .tab-btn.active { background: var(--accent); color: white; }

        /* Ø§Ù„Ù…ØªØ¬Ø± */
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 15px; }
        .p-card { background: var(--card); border-radius: 15px; border: 1px solid var(--gray); overflow: hidden; text-align: center; padding-bottom: 8px; }
        .p-card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .p-card h4 { font-size: 0.7rem; margin: 5px; color: #ccc; }
        .p-card b { color: var(--green); font-size: 0.8rem; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #111; width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; border: 1px solid #333; }

        .hidden { display: none !important; }
        .side-menu { position: fixed; top: 0; right: -100%; width: 85%; height: 100%; background: #000; z-index: 3000; transition: 0.4s; padding: 30px 20px; border-left: 1px solid #222; }
        .side-menu.active { right: 0; }
    </style>
</head>
<body>

<header>
    <div class="logo">KAREM STORE</div>
    <div id="userHeader" class="hidden">
        <span style="color:var(--green); font-weight:bold;"><span id="uBalDisplay">0</span> Ø¬</span>
    </div>
    <i class="fa-solid fa-bars-staggered" onclick="toggleMenu()" style="font-size: 1.5rem;"></i>
</header>

<div class="slider">
    <div class="slider-wrap" id="sliderWrap"></div>
</div>

<div class="container">
    <div id="adminPanel" class="hidden admin-section">
        <h3 style="color:var(--accent); margin:0 0 15px;">ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h3>
        <div style="display: flex; overflow-x: auto; padding-bottom: 10px;">
            <span class="tab-btn active" onclick="showTab('tab1', this)">Ø§Ù„Ø¨Ù†Ø±Ø§Øª</span>
            <span class="tab-btn" onclick="showTab('tab2', this)">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
            <span class="tab-btn" onclick="showTab('tab3', this)">Ø´Ø­Ù† ÙˆÙƒÙŠÙ„</span>
            <span class="tab-btn" onclick="showTab('tab4', this)">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</span>
        </div>

        <div id="tab1" class="admin-tab active">
            <input type="file" id="bFile" accept="image/*">
            <button class="btn btn-blue" onclick="uploadBanner()">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø±</button>
        </div>

        <div id="tab2" class="admin-tab">
            <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="pPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
            <select id="pCat"><option value="games">Ø£Ù„Ø¹Ø§Ø¨</option><option value="apps">ØªØ·Ø¨ÙŠÙ‚Ø§Øª</option></select>
            <input type="file" id="pFile" accept="image/*">
            <button class="btn btn-blue" onclick="uploadProduct()">Ø±ÙØ¹ Ù„Ù„Ù…ØªØ¬Ø±</button>
        </div>

        <div id="tab3" class="admin-tab">
            <input type="number" id="searchID" placeholder="Ø¨Ø­Ø« Ø¨ÙƒÙˆØ¯ Ø§Ù„ÙˆÙƒÙŠÙ„">
            <button class="btn btn-outline" onclick="searchAgent()">Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆÙƒÙŠÙ„</button>
            <div id="agentInfo" class="hidden" style="margin-top:10px; background:#000; padding:10px; border-radius:10px;">
                <p id="resName"></p>
                <input type="number" id="addAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <button class="btn btn-main" onclick="addMoney()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†</button>
            </div>
        </div>

        <div id="tab4" class="admin-tab">
            <div id="pendingDeposits"></div>
        </div>
    </div>

    <div class="grid" id="storeGrid"></div>
</div>

<div class="side-menu" id="sideMenu">
    <div id="guestMenu">
        <h3>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø²Ø§Ø¦Ø±</h3>
        <button class="btn btn-main" onclick="openAuth('login')">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        <button class="btn btn-outline" onclick="openAuth('signup')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div id="userMenu" class="hidden">
        <h3 id="mNameDisplay">--</h3>
        <p style="color:var(--blue)">ÙƒÙˆØ¯Ùƒ: <span id="mIDDisplay">--</span></p>
        <button class="btn btn-main" onclick="showModal('depositModal')">Ø´Ø­Ù† Ù…Ø­ÙØ¸ØªÙŠ</button>
        <button class="btn btn-outline" onclick="location.reload()" style="margin-top:20px;">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<div id="authModal" class="modal">
    <div class="modal-content">
        <h3 id="authTitle">--</h3>
        <div id="signupFields" class="hidden">
            <input type="text" id="regName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
        </div>
        <input type="email" id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="regPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-main" id="authSubmitBtn" onclick="handleAuth()">ØªØ£ÙƒÙŠØ¯</button>
        <button class="btn btn-outline" onclick="closeModal('authModal')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div id="depositModal" class="modal">
    <div class="modal-content">
        <h3>Ø´Ø­Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>
        <input type="number" id="dAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ„">
        <input type="file" id="dFile" accept="image/*">
        <button class="btn btn-main" onclick="sendScreenshot()">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        <button class="btn btn-outline" onclick="closeModal('depositModal')">Ø±Ø¬ÙˆØ¹</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAalmOWMUhvCi_PuFSUbXRpbe1hmGyer7s",
        authDomain: "karem-store.firebaseapp.com",
        databaseURL: "https://karem-store-default-rtdb.firebaseio.com",
        projectId: "karem-store",
        storageBucket: "karem-store.firebasestorage.app",
        messagingSenderId: "898294902448",
        appId: "1:898294902448:web:23cbee5afd72adcb67d575",
        measurementId: "G-V56WJVTN4J"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let authMode = 'login';
    let foundAgent = null;

    function toggleMenu() { document.getElementById('sideMenu').classList.toggle('active'); }
    function showModal(id) { document.getElementById(id).classList.add('active'); if(id=='authModal') toggleMenu(); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showTab(id, el) {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    function openAuth(mode) {
        authMode = mode;
        showModal('authModal');
        document.getElementById('authTitle').innerText = mode === 'login' ? 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„' : 'Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
        if(mode === 'signup') document.getElementById('signupFields').classList.remove('hidden');
        else document.getElementById('signupFields').classList.add('hidden');
    }

    // --- Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø¥Ù†Ø´Ø§Ø¡ ---
    function handleAuth() {
        const email = document.getElementById('regEmail').value.replace(/\./g, '_');
        const pass = document.getElementById('regPass').value;
        const name = document.getElementById('regName').value;

        db.ref('users/' + email).once('value', snap => {
            if(authMode === 'login') {
                if(snap.exists() && snap.val().pass === pass) login(snap.val());
                else alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·Ø£!");
            } else {
                if(snap.exists()) return alert("Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„Ø§Ù‹!");
                db.ref('lastID').transaction(c => {
                    const next = (c || 1000) + 1;
                    const u = { email, name, pass, balance: 0, uid: next, role: (name==='karem'?'admin':'user') };
                    db.ref('users/'+email).set(u);
                    db.ref('idMap/'+next).set(email);
                    login(u);
                    return next;
                });
            }
        });
    }

    function login(u) {
        currentUser = u;
        closeModal('authModal');
        document.getElementById('userHeader').classList.remove('hidden');
        document.getElementById('guestMenu').classList.add('hidden');
        document.getElementById('userMenu').classList.remove('hidden');
        document.getElementById('mNameDisplay').innerText = u.name;
        document.getElementById('mIDDisplay').innerText = u.uid;
        
        db.ref('users/'+u.email+'/balance').on('value', s => document.getElementById('uBalDisplay').innerText = s.val() || 0);
        if(u.role === 'admin' || u.name === 'karem') {
            document.getElementById('adminPanel').classList.remove('hidden');
            listenAdmin();
        }
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† ---
    function uploadBanner() {
        const file = document.getElementById('bFile').files[0];
        const r = new FileReader();
        r.onload = e => db.ref('banners').push({img: e.target.result});
        r.readAsDataURL(file);
    }

    function uploadProduct() {
        const n = document.getElementById('pName').value;
        const p = document.getElementById('pPrice').value;
        const c = document.getElementById('pCat').value;
        const file = document.getElementById('pFile').files[0];
        const r = new FileReader();
        r.onload = e => db.ref('products').push({n, p, c, img: e.target.result});
        r.readAsDataURL(file);
    }

    function searchAgent() {
        const id = document.getElementById('searchID').value;
        db.ref('idMap/'+id).once('value', snap => {
            if(!snap.exists()) return alert("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            db.ref('users/'+snap.val()).once('value', s => {
                foundAgent = s.val();
                document.getElementById('agentInfo').classList.remove('hidden');
                document.getElementById('resName').innerText = foundAgent.name + " (" + foundAgent.balance + " Ø¬)";
            });
        });
    }

    function addMoney() {
        const a = Number(document.getElementById('addAmt').value);
        db.ref('users/'+foundAgent.email).update({ balance: foundAgent.balance + a });
        alert("ØªÙ…!");
    }

    function listenAdmin() {
        db.ref('deposits').on('value', snap => {
            const div = document.getElementById('pendingDeposits');
            div.innerHTML = "";
            snap.forEach(s => {
                const d = s.val();
                div.innerHTML += `<div style="border:1px solid #333; padding:10px; margin-top:5px;">
                    ${d.name} (${d.amt}Ø¬) <img src="${d.img}" style="width:100px;display:block;">
                    <button class="btn btn-main" onclick="approveD('${d.user}',${d.amt},'${s.key}')">Ù‚Ø¨ÙˆÙ„</button>
                </div>`;
            });
        });
    }

    function approveD(u, a, k) {
        db.ref('users/'+u).once('value', s => {
            db.ref('users/'+u).update({balance: (s.val().balance||0)+a});
            db.ref('deposits/'+k).remove();
        });
    }

    // --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ---
    db.ref('banners').on('value', snap => {
        const w = document.getElementById('sliderWrap'); w.innerHTML = "";
        snap.forEach(s => w.innerHTML += `<img src="${s.val().img}">`);
    });
    setInterval(() => {
        const w = document.getElementById('sliderWrap');
        if(w.children.length > 1) {
            w.style.transition
